{
  "hash": "a27fbd74deab7a6c98e3794d0047cf17",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: The Capital Asset Pricing Model\nmetadata:\n  pagetitle: The CAPM with R\n  description-meta: Learn how to use the programming language R for estimating the CAPM for asset evaluation.\n---\n\n\n\n\nKey questions: \n\n- What is the expected return of an asset?\n- Which portfolios should investors hold?\n\nCAPM is an **equilibrium model**\n\n- Extends MPT by including **systematic risk**\n- Adds simplifying assumptions to model **rational investors**\n- Developed by: [Sharpe (1964)](https://onlinelibrary.wiley.com/doi/10.1111/j.1540-6261.1964.tb02865.x), [Lintner (1965)](https://www.jstor.org/stable/1924119?origin=crossref) & [Mossin (1966)](https://www.jstor.org/stable/1910098?origin=crossref)\n\nThe CAPM in a nutshell: investors demand a **compensation for risk**\n\n- Expected Return = Risk-Free Rate + Compensation for Market Risk\n- **Risk-Free Rate**: return on an investment without risk\n- **Market Risk**: how much asset returns co-move with the overall market\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidyfinance)\nlibrary(scales)\nlibrary(ggrepel)\n```\n:::\n\n\n\n\n## Asset Returns & Volatilities\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsymbols <- download_data(\n  type = \"constituents\",\n  index = \"Dow Jones Industrial Average\"\n)\n\nprices_daily <- download_data(\n    type = \"stock_prices\", symbol = symbols$symbol,\n    start_date = \"2019-10-01\", end_date = \"2024-09-30\"\n) |> \n  select(symbol, date,  price = adjusted_close)\n```\n:::\n\n\n\n\nCalculate *daily* returns\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreturns_daily <- prices_daily |>\n  group_by(symbol) |> \n  mutate(ret = price / lag(price) - 1) |>\n  ungroup() |> \n  select(symbol, date, ret) |> \n  drop_na(ret) |> \n  arrange(symbol, date)\n```\n:::\n\n\n\n\nPlot risk & return @fig-300\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nassets <- returns_daily |> \n  group_by(symbol) |> \n  summarize(mu = mean(ret), sigma = sd(ret))\n\nfig_vola_return <- assets |> \n  ggplot(aes(x = sigma, y = mu)) +\n  geom_point() + \n  geom_label_repel(data = assets |> filter(symbol %in% c(\"BA\", \"NVDA\")),\n                   aes(label = symbol)) +\n  scale_x_continuous(labels = percent) +\n  scale_y_continuous(labels = percent) + \n  labs(x = \"Volatility\", y = \"Average return\",\n       title = \"Average returns and volatilities of Dow index constituents\") \nfig_vola_return\n```\n\n::: {.cell-output-display}\n![Average returns and volatilities are based on returns adjusted for dividend payments and stock splits.](capital-asset-pricing-model_files/figure-html/fig-300-1.png){#fig-300 fig-alt='Title: Average returns and volatilities of Dow index constituents. The figure shows a scatter plot with volatities on the horizontal axis and average returns on the vertical axis. The stocks Nvidia and Boeing are highlighted because they exhibit the highest and lower average returns, respectively.' width=2100}\n:::\n:::\n\n\n\n\nDoes high risk bring high returns?\n\nBoeing (BA) vs Nvidia (NVDA)\n\n- Company-specific events might affect stock prices\n- Examples: CEO resignation, product launch, earnings report\n- Idiosyncratic events don't impact the overall market\n- This asset-specific risk can be eliminated through diversification\n\nFocus on **systematic risk** that affects all assets in the market\n\nSystematic vs idiosyncratic risk: Investors **dislike risk**\n\nDifferent sources of risk\n\n- **Systematic risk**: all assets are exposed to it, cannot be diversified away\n- **Idiosyncratic risk**: unique to particular asset, can be diversified away\n\n## Portfolio Return & Variance\n\n$\\text{Expected Portfolio Return} = \\omega'\\mu$\n\n  -\t$\\omega$: vector of asset weights\n  - $\\mu$: vector of expected return of assets\n\n$\\text{Portfolio Variance} = \\omega' \\Sigma \\omega$\n\n  - $\\Sigma$: variance-covariance matrix\n\nIntroducing the risk-free asset: Allocate capital between risk-free asset & risky portfolio\n\n$$\\mu_c = c \\omega'\\mu + (1-c)r_f$$\n\n- $\\mu_{c}$: combined portfolio return\n- $r_f$: return of risk-free asset (e.g. government bond)\n- $c$ fraction of capital in risky portfolio\n\nRisk-free asset has 0 volatility.\n\n- Portfolio risk $\\sigma_c$ is measured by volatility of risky asset\n- $\\sigma_c= c\\sqrt{\\omega' \\Sigma \\omega}$ $\\Rightarrow$ $c = \\frac{\\sigma_c}{\\sqrt{\\omega' \\Sigma \\omega}}$\n\nAllows us to derive a **Capital Allocation Line** (CAL) \n\n$$\\mu_c = r_f +\\sigma_c \\frac{\\omega'\\mu-r_f}{\\sqrt{\\omega' \\Sigma \\omega}}$$\n\nSlope of CAL is called **Sharpe ratio**\n\n$$\\text{Sharpe ratio} = \\frac{\\omega'\\mu-r_f}{\\sqrt{\\omega' \\Sigma \\omega}}$$\n\n- Measures **excess return per unit of risk**\n- Higher ratio indicates more attractive **risk-adjusted return**\n\nCalculate the risk-free rate: 13-week T-bill rate (^IRX) is quoted in annualized percentage yields. Convert annualized to daily rates (252 trading days). Note: this approach has a 99% correlation with Fama-French risk free rate.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrisk_free_daily <- download_data(\n  type = \"stock_prices\", symbol = \"^IRX\", \n  start_date = \"2019-10-01\", end_date = \"2024-09-30\"\n) |> \n  mutate(\n    risk_free = (1 + adjusted_close / 100)^(1 / 252) - 1\n  ) |> \n  select(date, risk_free) |> \n  drop_na()\n```\n:::\n\n\n\n\nCreate example portfolios\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmu <- assets$mu\nsigma <- returns_daily |> \n  pivot_wider(names_from = symbol, values_from = ret)  |> \n  select(-date) |> \n  cov()\n```\n:::\n\n\n\n\nPortfolio with equal weights\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnumber_of_assets <- nrow(assets)\nomega_ew <- rep(1 / number_of_assets, number_of_assets)\n\nsummary_ew <- tibble(\n  mu = as.numeric(t(omega_ew) %*% mu),\n  sigma = as.numeric(sqrt(t(omega_ew) %*% sigma %*% omega_ew)),\n  type = \"Equal-Weighted Portfolio\"\n)\n```\n:::\n\n\n\n\nPortfolio with random weights\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nomega_random <- runif(number_of_assets, -1, 1)\nomega_random <- omega_random / sum(omega_random)\n\nsummary_random <- tibble(\n  mu = as.numeric(t(omega_random) %*% mu),\n  sigma = as.numeric(sqrt(t(omega_random) %*% sigma %*% omega_random)),\n  type = \"Randomly-Weighted Portfolio\"\n)\n```\n:::\n\n\n\n\nRisk-free asset \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary_risk_free <- tibble(\n  mu =  mean(risk_free_daily$risk_free),\n  sigma = 0,\n  type = \"Risk-Free Asset\"\n)\n\nsummaries <- bind_rows(assets, summary_ew, summary_random, summary_risk_free)\n```\n:::\n\n\n\n\n\nPlot CALs. First introduce helper function to calculate Sharpe Ratio. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncalculate_sharpe_ratio <- function(mu, sigma, risk_free) {\n  as.numeric(mu - risk_free) / sigma \n}\n\nsummaries <- summaries |> \n  mutate(\n    sharpe_ratio = if_else(\n      str_detect(type, \"Portfolio\"), \n      calculate_sharpe_ratio(mu, sigma, risk_free = summary_risk_free$mu),\n      NA\n    ),\n    risk_free = summary_risk_free$mu\n  )\n```\n:::\n\n\n\n\nSee @fig-301\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig_cal <- summaries |> \n  ggplot(aes(x = sigma, y = mu)) +\n  geom_abline(aes(intercept = risk_free, slope = sharpe_ratio, color = type),\n              linetype = \"dashed\", linewidth = 1) +\n  geom_point(data = summaries |> filter(is.na(type))) +\n  geom_point(data = summaries |> filter(!is.na(type)), shape = 4, size = 4) + \n  geom_label_repel(aes(label = type)) + \n  scale_x_continuous(labels = percent) +\n  scale_y_continuous(labels = percent) + \n  labs(\n    x = \"Volatility\", y = \"Average return\",\n    title = \"Average returns and volatilities of Dow index constituents with capital allocation lines\"\n  ) +\n  theme(legend.position = \"none\")\nfig_cal\n```\n\n::: {.cell-output-display}\n![Points correspond to individual assets, crosses to portfolios.](capital-asset-pricing-model_files/figure-html/fig-301-1.png){#fig-301 fig-alt='Title: Average returns and volatilities of Dow index constituents with capital allocation lines. he figure shows a scatter plot with volatities on the horizontal axis and average returns on the vertical axis. In addition, the figure shows capital allocation lines that connect the risk-free asset to the equal-weighted and randomly-weighted portfolio, respectively.' width=2100}\n:::\n:::\n\n\n\n\n## The Tangency Portfolio\n\nThe portfolio that **maximizes Sharpe ratio**\n\n$$\\max_w \\frac{\\omega' \\mu - r_f}{\\sqrt{\\omega' \\Sigma \\omega}}$$\nwhile staying **fully invested**\n\n$$ \\omega'\\iota = 1$$\n\nis called the **tangency portfolio**\n\nCalculate the tangency portfolio\n\n**Analytic solution** for tangency portfolio (see [here](https://bookdown.org/compfinezbook/introcompfinr/Efficient-portfolios-of.html#computing-the-tangency-portfolio-using-matrix-algebra))\n\n$$\\omega_{tan}=\\frac{\\Sigma^{-1}(\\mu-r_f)}{\\iota'\\Sigma^{-1}(\\mu-r_f)}$$\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nomega_tangency <- solve(sigma) %*% (mu - summary_risk_free$mu)\nomega_tangency <- as.vector(omega_tangency / sum(omega_tangency))\n\nsummary_tangency <- tibble(\n  mu = as.numeric(t(omega_tangency) %*% mu),\n  sigma = as.numeric(sqrt(t(omega_tangency) %*% sigma %*% omega_tangency)),\n  type = \"Tangency Portfolio\",\n  sharpe_ratio = calculate_sharpe_ratio(mu, sigma, risk_free = summary_risk_free$mu),\n  risk_free = summary_risk_free$mu\n)\n```\n:::\n\n\n\n\n## The Capital Market Line \n\nCombination of risk-free asset & the tangency portfolio $\\omega_{tan}$\n\n$$\\mu_{c} = r_f +\\sigma_c \\frac{\\omega_{tan}'\\mu-r_f}{\\sqrt{\\omega_{tan}' \\Sigma \\omega_{tan}}}$$\n\nis called the **Capital Market Line** (CML)\n\n<br>\n\nCML describes **best risk-return trade-off** for portfolios that contain risk-free asset & tangency portfolio\n\nPlot the CML\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummaries <- bind_rows(summaries, summary_tangency)\n\nfig_cml <- summaries |> \n  ggplot(aes(x = sigma, y = mu)) +\n  geom_abline(aes(intercept = risk_free, slope = sharpe_ratio, color = type),\n              linetype = \"dashed\", linewidth = 1) +\n  geom_point(data = summaries |> filter(is.na(type))) +\n  geom_point(data = summaries |> filter(!is.na(type)), shape = 4, size = 4) + \n  ggrepel::geom_label_repel(aes(label = type)) + \n  scale_x_continuous(labels = percent) +\n  scale_y_continuous(labels = percent) + \n  labs(x = \"Volatility\", y = \"Average return\",\n       title = \"Average returns and volatilities of Dow index constituents with the capital market line\") +\n  theme(legend.position = \"none\")\nfig_cml\n```\n\n::: {.cell-output-display}\n![Points correspond to individual assets, crosses to portfolios.](capital-asset-pricing-model_files/figure-html/fig-302-1.png){#fig-302 fig-alt='Title: Average returns and volatilities of Dow index constituents with capital allocation lines. he figure shows a scatter plot with volatities on the horizontal axis and average returns on the vertical axis. In addition, the figure shows capital allocation lines that connect the risk-free asset to the equal-weighted, randomly-weighted, and tangency portfolio, respectively.' width=2100}\n:::\n:::\n\n\n\n\nPortfolios vs individual assets. In the CAPM model:\n\n- Investors prefer to hold any portfolio on the CML over individual assets or any other portfolio\n- All rational investors hold the tangency portfolio\n- Return of an individual asset can be compared to efficient tangency weight\n- Risk of an asset is proportional to covariance with tangency portfolio weight\n\nExpected excess returns vs tangency weights. **Expected excess return of asset** $i$ is\n\n$$\\mu_i - r_f = \\beta_i \\cdot (\\omega_{tan}'\\mu - r_f)$$\n\nwhere\n\n$$\\beta_i = \\frac{\\text{Cov}(r_i, \\omega_{tan}r)}{\\omega_{tan}' \\Sigma \\omega_{tan}}$$\n\nis called the **asset beta**\n\nCalculate excess returns\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntangency_weights <- tibble(\n  symbol = assets$symbol, \n  omega_tangency = omega_tangency\n)\n\nreturns_tangency_daily <- returns_daily |> \n  left_join(tangency_weights, join_by(symbol)) |> \n  group_by(date) |> \n  summarize(mkt_ret = weighted.mean(ret, omega_tangency))\n\nreturns_excess_daily <- returns_daily |> \n  left_join(returns_tangency_daily, join_by(date)) |> \n  left_join(risk_free_daily, join_by(date)) |> \n  mutate(ret_excess = ret - risk_free,\n         mkt_excess = mkt_ret - risk_free) |> \n  select(symbol, date, ret_excess, mkt_excess)\n```\n:::\n\n\n\n\nEstimate Asset Betas\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nestimate_beta <- function(data) {\n  fit <- lm(\"ret_excess ~ mkt_excess - 1\", data = data)\n  coefficients(fit)\n}\n  \nbeta_results <- returns_excess_daily |> \n  nest(data = -symbol) |> \n  mutate(beta = map_dbl(data, estimate_beta))\n```\n:::\n\n\n\n\nPlot asset betas\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig_betas <- beta_results |> \n  ggplot(aes(x = beta, y = fct_reorder(symbol, beta))) +\n  geom_col() +\n  labs(\n    x = \"Estimated asset beta\", y = NULL, \n    title = \"Estimated asset betas based on the tangency portfolio for Dow index constituents\"\n  )\nfig_betas\n```\n\n::: {.cell-output-display}\n![Weights are based on returns adjusted for dividend payments and stock splits.](capital-asset-pricing-model_files/figure-html/fig-303-1.png){#fig-303 fig-alt='Title: Estimated asset betas based on the tangency portfolio for Dow index constituents. The figure shows a bar chart with estimated asset betas for each Dow index constituent.' width=2100}\n:::\n:::\n\n\n\n\nAsset returns vs systematic risk: the assets all fall onto the 45 degree line, as they should according to CAPM @fig-304\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nassets <- assets |> \n  mutate(mu_excess = mu - summary_risk_free$mu) |> \n  left_join(beta_results, join_by(symbol))\n  \nfig_betas_returns <- assets |> \n  ggplot(aes(x = beta, y = mu_excess)) + \n  geom_abline(intercept = 0, \n              slope = summary_tangency$mu - summary_risk_free$mu) + \n  geom_point() +\n  geom_label_repel(data = assets |> filter(symbol %in% c(\"BA\", \"NVDA\")),\n                   aes(label = symbol)) + \n  scale_y_continuous(labels = percent) + \n  labs(\n    x = \"Estimated asset beta\", y = \"Average return\", \n    title = \"Estimated CAPM-betas and average returns for Dow index constituents\"\n  )\nfig_betas_returns\n```\n\n::: {.cell-output-display}\n![Estimates are based on returns adjusted for dividend payments and stock splits and using the tangency portfolio as a measure for the market.](capital-asset-pricing-model_files/figure-html/fig-304-1.png){#fig-304 fig-alt='Title: Estimated CAPM-betas and average returns for Dow index constituents. The figure shows a bar scatter plot with estimated asset betas on the horizontal and average returns on the vertical axis. All points fall onto the 45-degree line.' width=2100}\n:::\n:::\n\n\n\n\n## CAPM in Practice\n\nHow to estimate betas in practice?\n\nCalculating the **tangency portfolio** can be **cumbersome**\n\n- What is the correct asset universe?\n- How to estimate $\\mu$ and $\\Sigma$ for many assets?\n\nIn the CAPM: **market portfolio = tangency portfolio**\n\n- Skip calculation of tangency portfolio weights\n- Use portfolios weighted by market capitalization \n\nKey assumptions behind CAPM:\n\n- Equilibrium model in a single-period economy\n-\tNo transaction costs or taxes\n-\tRisk-free borrowing and lending are available to all investors\n-\tInvestors share homogeneous expectations\n-\tInvestors maximize returns for limited level of risk\n\nCAPM is a **foundation for other models** because of its simplicity\n\nThe Security Market Line (SML). **Expected return of asset** $i$ is\n\n$$\\mu_i =  r_f + \\beta_i \\cdot (\\mu_m - r_f)$$\n\nwhere\n\n$$\\beta_i = \\frac{\\sigma_{im}}{\\sigma_m^2}$$\n\n- $\\mu_m$: expected market returns\n- $\\sigma_{im}$: covariance of asset $i$ with market\n- $\\sigma_m$: market volatility\n\nEvaluate asset performance with the SML: **Alpha** is difference between actual excess return & expected return\n\n$$\\mu_i - r_f = \\alpha_i + \\beta_i \\cdot (\\mu_m - r_f)$$\n\nAlpha is **performance adjusted for market risk**\n\n- **Positive alpha**: outperformance relative to market\n- **Negative alpha**: underperformance relative to market\n\nEstimate Asset Alphas & Beta. Regression model:\n\n$$r_{i,t}  - r_{f,t}  = \\hat{\\alpha}_i + \\hat{\\beta}_i \\cdot (r_{m,t} - r_{f,t} ) + \\hat{\\varepsilon}_{i,t} $$\n\n- $r_{i,t}$: actual returns of asset $i$ on day $t$\n- $r_{m,t}$: actual market returns on day $t$\n\nDownload excess market returns\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfactors <- download_data(\n  type = \"factors_ff_5_2x3_daily\", \n  start_date = \"2019-10-01\", end_date = \"2024-09-30\"\n) |> \n  select(date, mkt_excess, risk_free)\n```\n:::\n\n\n\n\nEstimate alphas & betas\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreturns_excess_daily <- returns_daily |> \n  left_join(factors, join_by(date)) |> \n  mutate(ret_excess = ret - risk_free) |> \n  select(symbol, date, ret_excess, mkt_excess)\n\nestimate_capm <- function(data) {\n  fit <- lm(\"ret_excess ~ mkt_excess\", data = data)\n  tibble(\n    coefficient = c(\"alpha\", \"beta\"),\n    estimate = coefficients(fit),\n    t_statistic = summary(fit)$coefficients[, \"t value\"]\n  )\n}\n  \ncapm_results <- returns_excess_daily |> \n  nest(data = -symbol) |> \n  mutate(capm = map(data, estimate_capm)) |> \n  unnest(capm) |> \n  select(symbol, coefficient, estimate, t_statistic)\n```\n:::\n\n\n\n\nPlot asset alphas\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig_alpha <- capm_results |> \n  filter(coefficient == \"alpha\") |> \n  mutate(is_significant = abs(t_statistic) >= 1.96) |> \n  ggplot(aes(x = estimate, y = fct_reorder(symbol, estimate), \n             fill = is_significant)) +\n  geom_col() +\n  scale_x_continuous(labels = percent) + \n  labs(\n    x = \"Estimated asset alphas\", y = NULL, fill = \"Significant at 95%?\",\n    title = \"Estimated CAPM alphas for Dow index constituents\"\n  )\nfig_alpha\n```\n\n::: {.cell-output-display}\n![Estimates are based on returns adjusted for dividend payments and stock splits and using the Fama-French market excess returns as a measure for the market.](capital-asset-pricing-model_files/figure-html/fig-305-1.png){#fig-305 fig-alt='Title: Estimated CAPM alphas for Dow index constituents. The figure shows a bar chart with estimated alphas and indicates whether an estimate is statistically significant at 95%. Only Nvidia exhibits a statistically significant positive alpha.' width=2100}\n:::\n:::\n\n\n\n\n## Shortcomings & Extensions\n\nPopular shortcomings of CAPM\n\n- Impossible to create **universal measure for market**\n  - Market definition might depend on context (e.g. S&P 500, DAX, TOPIX)\n- **Beta** might **not be stable **over time\n  - Company operations, leverage or competitive environment might change beta\n- **Systematic risk** might not be the **only factor**\n  - Poor empirical performance in explaining small-cap or high-growth returns\n- Many more: behavioral biases, heterogeneous preferences, liquidity, etc.\n\nAlternatives & extensions.\n\n[Fama-French 3-Factor model](https://en.wikipedia.org/wiki/Fama%E2%80%93French_three-factor_model) extends CAPM\n\n- Outperformance of small vs big companies (see [tidy-finance.org](size-sorts-and-p-hacking.qmd))\n- Outperformance of high vs low value companies (see [tidy-finance.org](value-and-bivariate-sorts.qmd))\n  \nFama-French 5-Factor model extends 3-factor model (see [tidy-finance.org](replicating-fama-and-french-factors.qmd))\n\n- Outperformance of companies with robust vs weak operating profitability\n- Outperformance of companies with conservative vs aggressive investment\n\nMany more: [consumption CAPM](https://en.wikipedia.org/wiki/Consumption-based_capital_asset_pricing_model), [conditional CAPM](https://www.jstor.org/stable/2329301), [Carhart Four-Factor Model](https://en.wikipedia.org/wiki/Carhart_four-factor_model), [Q-Factor Model & ivnestment CAPM](https://global-q.org/index.html)\n\n## Key takeways\n\n- CAPM is an **equilibrium model** in a **frictionless** economy\n- Investors hold mix of **market portfolio & risk-free asset**\n- **Expected return** of a stock is a linear function of its **beta**\n- Beta is the **sensitivity** of a stock to **market movements**\n- Beta estimation via **linear regression** using historical data\n\n## Exercises\n\n1. ...\n",
    "supporting": [
      "capital-asset-pricing-model_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}