{
  "hash": "165524820ec6aac5a688d0d5154372ab",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Discounted Cash Flow Analysis\nmetadata:\n  pagetitle: DCF with R\n  description-meta: Learn how to use the programming language R to value companies using discounted cash flow analysis.\n---\n\n\n\n\nWhat is the value of a company?\n\nCompany valuation helps determine the economic value of a business for purposes like investment, mergers, acquisitions or financial reporting\n\nCommon valuation methods:\n\n-   Market-based: compare to similar companies (e.g., P/E multiples)\n-   Asset-based: focus on net asset value (e.g., book value)\n-   Income-based: value based on expected future earnings (e.g., DCF)\n\nFocus on discounted cash flow (DCF) analysis\n\n-   Accounts for the time value of money & company-specific factors\n-   Focuses on future cash flows, not just historical data\n-   Applicable across industries & company sizes\n-   Can also be used to value projects\n-   Foundation for long-term strategic decision making\n\nKey components of DCF\n\nForecasted free cash flows\n\n-   Represents expected future earnings & their timing\n-   Includes adjustments for taxes, investments & working capital\n\nContinuation / terminal value\n\n-   Captures the value of the business beyond the explicit forecast period\n-   Common methods: perpetuity growth model & exit multiple approach\n\nDiscount rate\n\n-   Reflects the riskiness of the cash flows & the required rate of return\n-   Typically uses the Weighted Average Cost of Capital (WACC)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidyfinance)\nlibrary(scales)\nlibrary(fmpapi)\n```\n:::\n\n\n\n\n## Prepare Data\n\n- Import data using [Financial Modeling Prep (FMP) API](https://site.financialmodelingprep.com/developer/docs)\n- R package: [tidy-finance/r-fmpapi](https://github.com/tidy-finance/r-fmpapi)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsymbol <- \"MSFT\"\n\nincome_statements <- fmp_get(\"income-statement\", symbol, list(period = \"annual\", limit = 5))\ncash_flow_statements <- fmp_get(\"cash-flow-statement\", symbol, list(period = \"annual\", limit = 5))\n```\n:::\n\n\n\n\nFree cash flow (FCF): Cash that a company generates after accounting for outflows to support operatings & maintain capital assets\n\n$$\\text{FCF} = \\text{EBIT} + \\text{Depreciation & Amortization} - \\text{Taxes} + \\Delta \\text{Working Capital} - \\text{CAPEX}$$\n\nAlternative ways to define free cash flow: [investopedia.com](https://www.investopedia.com/terms/f/freecashflow.asp)\n\nCalculate FCF\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndcf_data <- income_statements |> \n  mutate(\n    ebit = net_income + income_tax_expense - interest_expense - interest_income\n  ) |> \n  select(\n    year = calendar_year, \n    ebit, revenue, depreciation_and_amortization, taxes = income_tax_expense\n  ) |> \n  left_join(\n    cash_flow_statements |> \n      select(year = calendar_year, \n             delta_working_capital = change_in_working_capital,\n             capex = capital_expenditure), join_by(year)\n  ) |> \n  mutate(\n    fcf = ebit + depreciation_and_amortization - taxes + delta_working_capital - capex\n  ) |> \n  arrange(year) \n```\n:::\n\n\n\n\n## Forecast Free-Cash-Flow\n\nTypical financial analyst approach:\n\n-   Balance data-driven analysis with informed judgement to forecast FCF\n-   Express components of FCF as financial ratios relative to revenue\n-   Make subjective guess for future dynamics of ratios based on company analysis\n-   Forecast revenue growth (e.g., based on macroeconomic outlooks)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndcf_data <- dcf_data |> \n  mutate(\n    revenue_growth = revenue / lag(revenue) - 1,\n    operating_margin = ebit / revenue,\n    da_margin = depreciation_and_amortization / revenue,\n    taxes_to_revenue = taxes / revenue,\n    delta_working_capital_to_revenue =  delta_working_capital / revenue,\n    capex_to_revenue = capex / revenue\n  )\n\nfig_financial_ratios <- dcf_data |> \n  pivot_longer(cols = c(operating_margin:capex_to_revenue)) |>\n  ggplot(aes(x = year, y = value, color = name)) +\n  geom_line() +\n  scale_x_continuous(breaks = pretty_breaks()) +\n  scale_y_continuous(labels = percent) +\n  labs(\n    x = NULL, y = NULL, color = NULL,\n    title = \"Key financial ratios of Microsoft between 2020 and 2024\"\n  )\nfig_financial_ratios\n```\n\n::: {.cell-output-display}\n![Ratios are based on financial statements as provided through the FMP API.](discounted-cash-flow-analysis_files/figure-html/fig-500-1.png){#fig-500 fig-alt='Title: Key financial ratios of Microsoft between 2020 and 2024. The figure shows a line chart with years on the horizontal axis and financial ratios on the vertical axis.' width=2100}\n:::\n:::\n\n\n\n\nDefine ratio dynamics @fig-501\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndcf_data_forecast_ratios <- tribble(\n  ~year, ~operating_margin, ~da_margin, ~taxes_to_revenue, ~delta_working_capital_to_revenue, ~capex_to_revenue,\n  2025, 0.41, 0.09, 0.08, 0.001, -0.2,\n  2026, 0.42, 0.09, 0.07, 0.001, -0.22,\n  2027, 0.43, 0.09, 0.06, 0.001, -0.2,\n  2028, 0.44, 0.09, 0.06, 0.001, -0.18,\n  2029, 0.45, 0.09, 0.06, 0.001, -0.16\n) |> \n  mutate(type = \"Forecast\")\n\ndcf_data <- dcf_data |> \n  mutate(type = \"Realized\") |> \n  bind_rows(dcf_data_forecast_ratios)\n\nfig_financial_ratios_forecast <- dcf_data |> \n  pivot_longer(cols = c(operating_margin:capex_to_revenue)) |> \n  ggplot(aes(x = year, y = value, color = name, linetype = rev(type))) +\n  geom_line() +\n    scale_x_continuous(breaks = pretty_breaks()) +\n  scale_y_continuous(labels = percent) +\n  labs(\n    x = NULL, y = NULL, color = NULL, linetype = NULL,\n    title = \"Key financial ratios and ad-hoc forecasts of Microsoft between 2020 and 2029\"\n  )\nfig_financial_ratios_forecast\n```\n\n::: {.cell-output-display}\n![Realized ratios are based on financial statements as provided through the FMP API, while forecasts are manually defined.](discounted-cash-flow-analysis_files/figure-html/fig-501-1.png){#fig-501 fig-alt='Title: Key financial ratios and ad-hoc forecasts of Microsoft between 2020 and 2029. The figure shows a line chart with years on the horizontal axis and financial ratios and their forecasts on the vertical axis.' width=2100}\n:::\n:::\n\n\n\n\n## Forecast Revenue Growth\n\n-   Get current [IMF World Economic Outlook (WEO)](https://www.imf.org/en/Publications/WEO/weo-database/2024/October/weo-report?c=111,&s=NGDP_RPCH,&sy=2020&ey=2029&ssm=0&scsm=1&scc=0&ssd=1&ssc=0&sic=1&sort=country&ds=.&br=1) data for US\n-   IMF publishes analyses of global economy, including trends & forecasts\n-   Last forecast update: October 2024\n-   Simple approach: model revenue growth as a linear function of GDP growth\n\nAlternative: look up consensus analyst forecasts (typically proprietary)\n\nCreate forecasts using IMF WEO\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngdp_growth <- tibble(\n  year = 2020:2029,\n  gdp_growth = c(-0.02163, 0.06055,\t0.02512, 0.02887, 0.02765, 0.02153, 0.02028, 0.02120, 0.02122, 0.02122)\n)\n\ndcf_data <- dcf_data |> \n  left_join(gdp_growth, join_by(year)) \n\nrevenue_growth_model <- dcf_data |> \n  lm(revenue_growth ~ gdp_growth, data = _) |> \n  coefficients()\n \ndcf_data <- dcf_data |> \n  mutate(\n    revenue_growth_modeled = revenue_growth_model[1] + revenue_growth_model[2] * gdp_growth,\n    revenue_growth = if_else(type == \"Forecast\", revenue_growth_modeled, revenue_growth)  \n  ) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfig_growth <- dcf_data |> \n  filter(year >= 2021) |> \n  pivot_longer(cols = c(revenue_growth, gdp_growth)) |> \n  ggplot(aes(x = year, y = value, color = name, linetype = rev(type))) +\n  geom_line() +\n  scale_x_continuous(breaks = pretty_breaks()) +\n  scale_y_continuous(labels = percent) +\n  labs(\n    x = NULL, y = NULL, color = NULL, linetype = NULL,\n    title = \"GDP growth and Microsoft revenue growth and modeled forecasts between 2020 and 2029\"\n  )\nfig_growth\n```\n\n::: {.cell-output-display}\n![Realized revue growth rates are based on financial statements as provided through the FMP API, while forecasts are modeled unsing IMF WEO forecasts.](discounted-cash-flow-analysis_files/figure-html/fig-502-1.png){#fig-502 fig-alt='Title: GDP growth and Microsoft revenue growth and modeled forecasts between 2020 and 2029. The figure shows a line chart with years on the horizontal axis and gdp growth, revenue growth and their forecasts on the vertical axis.' width=2100}\n:::\n:::\n\n\n\n\n## Calculate FCF Forecasts\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndcf_data$revenue_growth[1] <- 0\ndcf_data$revenue <- dcf_data$revenue[1] * cumprod(1 + dcf_data$revenue_growth)\n\ndcf_data <- dcf_data |> \n  mutate(\n    ebit = operating_margin * revenue,\n    depreciation_and_amortization = da_margin * revenue,\n    taxes = taxes_to_revenue * revenue,\n    delta_working_capital = delta_working_capital_to_revenue * revenue,\n    capex = capex_to_revenue * revenue,\n    fcf = ebit + depreciation_and_amortization - taxes + delta_working_capital - capex\n  )\n```\n:::\n\n\n\n\nVisualize FCF\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig_fcf <- dcf_data |>\n  ggplot(aes(x = year, y = fcf / 1e9)) +\n  geom_col(aes(fill = type)) +\n  scale_x_continuous(breaks = pretty_breaks()) +\n  scale_y_continuous(labels = comma) + \n  labs(\n    x = NULL, y = \"Free Cash Flow (in B USD)\", fill = NULL,\n    title = \"Actual and predicted free cash flow for Microsoft from 2020 to 2029\"\n  )\nfig_fcf\n```\n\n::: {.cell-output-display}\n![Realized growth rates are based on financial statements as provided through the FMP API, while forecasts are manually defined.](discounted-cash-flow-analysis_files/figure-html/fig-503-1.png){#fig-503 fig-alt='Title: GDP growth and Microsoft revenue growth and modeled forecasts between 2020 and 2029. The figure shows a line chart with years on the horizontal axis and gdp growth, revenue growth and their forecasts on the vertical axis.' width=2100}\n:::\n:::\n\n\n\n\n## Continuation Value\n\nPerpetuity growth model: cash flows grow at a constant rate indefinitely\n\n$$TV_{T} = \\frac{{FCF_{T+1}}}{{r - g}}$$\n\n-   $r$ is the discount rate\n-   $g$ is the perpetual growth rate\n\nAlternative: estimate continuation value based on multiple of EBITDA ([exit multiple approach](https://corporatefinanceinstitute.com/resources/valuation/exit-multiple/))\n\nContinuation value with perpetuity growth\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncompute_terminal_value <- function(last_fcf, growth_rate, discount_rate){\n  last_fcf * (1 + growth_rate) / (discount_rate - growth_rate)\n}\n\nlast_fcf <- tail(dcf_data$fcf, 1)\nterminal_value <- compute_terminal_value(last_fcf, 0.04, 0.08)\nterminal_value / 1e9\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 7564\n```\n\n\n:::\n:::\n\n\n\n\n## Discount Rates\n\nWACC represents the average rate of return required by all investors (equity & debt holders)\n\n$$WACC = \\frac{E}{D+E} \\cdot r^E + \\frac{D}{D+E} \\cdot r^D \\cdot (1 - \\tau)$$\n\n-   $E$ is equity with return $r^E$\n-   $D$ is debt with pre-tax return $r^D$\n-   $\\tau$ is the tax rate\n\nf you want to estimate WACC yourself\n\n- E is often measured by subtracting net debt from enterprise value\n- D is often measured by book value\n- $r^E$ estimated via [CAPM](https://talks.tidy-finance.org/#r-consortium-webinar-evaluate-performance-using-the-capital-asset-pricing-model)\n- $r^D$ estimatation via:\n    - Calculate [effective interest](https://finbox.com/NASDAQGS:MSFT/explorer/interest_rate_effective/) (interest expense / total debt)\n    - Get bond spreads for rating group of company (best rating for Microsoft)\n\nDownload WACC for Computer Services\n\nUseful data source: [Aswath Damodaran](https://pages.stern.nyu.edu/~adamodar/New_Home_Page/datacurrent.html)\n\n-   Extensive database with estimated discount rates, cash flows, growth rates, multiples, etc. for regions & industries\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\n\nfile <- tempfile(fileext = \"xls\")\n\nurl <- \"https://pages.stern.nyu.edu/~adamodar/pc/datasets/wacc.xls\"\ndownload.file(url, file)\nwacc_raw <- read_xls(file, sheet = 2, skip = 18)\nunlink(file)\n\nwacc <- wacc_raw |> \n  filter(`Industry Name` == \"Computer Services\") |> \n  pull(`Cost of Capital`)\n```\n:::\n\n\n\n\n## Compute DCF Value\n\n$$\n\\text{Total DCF Value} = \\sum_{t=1}^{\\text{T}} \\frac{\\text{FCF}_t}{(1 + \\text{WACC})^t} + \\frac{\\text{TV}_{T}}{(1 + \\text{WACC})^{\\text{T}}}\n$$\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nforecasted_years <- 5\n\ncompute_dcf <- function(wacc, growth_rate, years = 5) {\n  free_cash_flow <- dcf_data$fcf\n  last_fcf <- tail(free_cash_flow, 1)\n  terminal_value <- compute_terminal_value(last_fcf, growth_rate, wacc)\n  \n  present_value_fcf <- free_cash_flow / (1 + wacc)^(1:years)\n  present_value_tv <- terminal_value / (1 + wacc)^years\n  total_dcf_value <- sum(present_value_fcf) + present_value_tv\n  total_dcf_value\n}\n\ncompute_dcf(wacc, 0.03) / 1e9\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 6084\n```\n\n\n:::\n:::\n\n\n\n\n## Sensitvity Analysis\n\nDCF is full of assumptions:\n\n- Forecast ratios\n- Short-term revenue growth forecasts\n- Perpetual growth rate\n- WACC estimation\n\nCheck how sensitive valuations are due to different assumptions\n\nWACC & growth scenarios\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwacc_range <- seq(0.06, 0.08, by = 0.01)\ngrowth_rate_range <- seq(0.02, 0.04, by = 0.01)\n\nsensitivity <- expand_grid(\n  wacc = wacc_range,\n  growth_rate = growth_rate_range\n) |>\n  mutate(value = pmap_dbl(list(wacc, growth_rate), compute_dcf))\n\nfig_sensitivity <- sensitivity |> \n  mutate(value = round(value / 1e9, 0)) |> \n  ggplot(aes(x = wacc, y = growth_rate, fill = value)) +\n  geom_tile() +\n  geom_text(aes(label = comma(value)), color = \"white\") +\n  scale_x_continuous(labels = percent) + \n  scale_y_continuous(labels = percent) +\n  scale_fill_continuous(labels = comma) + \n  labs(\n    title = \"DCF value of Microsoft for different WACC and growth scenarios\",\n    x = \"WACC\",\n    y = \"Perpetual growth rate\",\n    fill = \"Company value\"\n  ) + \n  guides(fill = guide_colorbar(barwidth = 15, barheight = 0.5))\nfig_sensitivity\n```\n\n::: {.cell-output-display}\n![DCF value combines data from FMP API, ad-hoc forecasts of financial ratios, and IMF WEO growth forecasts.](discounted-cash-flow-analysis_files/figure-html/fig-504-1.png){#fig-504 fig-alt='Title: DCF value of Microsoft for different WACC and growth scenarios. The figure shows a tile chart different values of WACC on the horizontal axis and perpetual growth rates on the vertical axis. Each tile shows a corresponding DCF value, illustrating the sensitivity of the DCF analysis to assumptions.' width=2100}\n:::\n:::\n\n\n\n\n## From DCF to Equity Value\n\nDCF model provides an estimate for value of operations\n\n$$\\text{Equity Value} = \\text{DCF Value} + \\text{Non-Operating Assets} - \\text{Value of Debt}$$\n\n- Non-Operating Assets: not essential to operations, but generate income (e.g., marketable securities, vacant land, idle equipment)\n- Value of Debt: in theory market value of total debt, in practice book debt\n\n## Key takeaways\n\n- DCF delivers a structured approach for informed decisions\n- DCF values companies or projects based on projected cash flows\n- Core elements: free cash flow, continuation value, WACC\n- Validate assumptions: financial rations, revenue growth, WACC matter\n\n## Exercises\n\n1. ...\n\n",
    "supporting": [
      "discounted-cash-flow-analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}