---
title: Discounted Cash Flow Analysis
metadata:
  pagetitle: DCF with R
  description-meta: Learn how to use the programming language R to value companies using discounted cash flow analysis.
---

In this chapter, we address a fundamental question: what is the value of a company? ompany valuation is a critical tool that helps us determine the economic value of a business. Whether it’s for investment decisions, mergers and acquisitions, or financial reporting, understanding a company’s value is essential. But valuation isn’t just about assigning a number - it’s about providing a framework for making informed decisions. For example, investors use valuation to identify whether a stock is under- or over-valued. Companies rely on valuation for strategic decisions, like pricing an acquisition or preparing for an IPO.

There are several approaches to valuation, each suited to different purposes and scenarios: 

- Market-based valuation compares the company to others in the market, often using multiples like the Price-to-Earnings ratio or Enterprise Value-to-EBITDA. It’s quick and intuitive but relies heavily on the availability of comparable data.
- Asset-based valuation focuses on the net value of a company’s assets. For instance, the book value method considers what the company would be worth if it sold off all its assets and settled its liabilities. It’s straightforward but doesn’t always capture intangible assets like brand value or future growth potential.
- Income-based valuation puts the focus on the company’s ability to generate future earnings. A popular method in this category is Discounted Cash Flow (DCF) which estimates value based on expected future cash flows discounted to present value. This method is comprehensive but requires robust assumptions about the future.

We focus on DCF analysis in this chapter for a couple of reasons:

- DCF accounts for the time value of money—a dollar today is worth more than a dollar in the future. By discounting future cash flows back to the present, we ensure that our valuation reflects the cost of waiting and the risk involved.
- Unlike methods that only rely on historical data, DCF adresses future cash flows. This forward-looking approach makes it especially useful for dynamic businesses where past performance doesn’t fully capture future potential.
- DCF is applicable across industries and company sizes, whether you’re valuing a tech startup or a mature manufacturing firm. It’s also adaptable for companies with varying capital structures or growth trajectories.
- DCF isn’t limited to valuing companies - it’s also a great tool for assessing the viability of individual projects..

Because it focuses on long-term cash flows and risk factors, DCF serves as a foundation for long-term strategic decision making. It helps management, investors, and analysts take a holistic view of a company’s future value.

DCF in its essence comprises of three key components. The first component is forecasted free cash flows (FCF), which represent the expected future earnings of the company. FCF measure the cash that remains after accounting for operating expenses, taxes, investments, and changes in working capital. They give us a clear picture of the cash available for distribution to investors, making them a key indicator of value.

Next, we have the continuation value, also known as the terminal value. This captures the value of the business beyond the explicit forecast period. Since forecasting cash flows far into the future is inherently uncertain, the terminal value accounts for the bulk of a company’s value in many DCF analyses.

The final component is the discount rate, which adjusts future cash flows to their present value by accounting for risk and the time value of money. Typically, we use the Weighted Average Cost of Capital (WACC), which combines the costs of equity and debt, weighted by their proportion in the company’s capital structure. In practice, getting the WACC right is crucial, as small changes in the discount rate can have a significant impact on the final valuation.

In this chapter, we rely on the following packages to build a simple DCF analysis:

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(tidyfinance)
library(scales)
library(fmpapi)
```

## Prepare Data

- Import data using [Financial Modeling Prep (FMP) API](https://site.financialmodelingprep.com/developer/docs)
- R package: [tidy-finance/r-fmpapi](https://github.com/tidy-finance/r-fmpapi)

```{r}
#| cache: true
symbol <- "MSFT"

income_statements <- fmp_get("income-statement", symbol, list(period = "annual", limit = 5))
cash_flow_statements <- fmp_get("cash-flow-statement", symbol, list(period = "annual", limit = 5))
```

FCF is the cash that a company generates after accounting for outflows to support operatings & maintain capital assets. It represents the cash available to investors - both equity holders and debt holders - after a company has met its operational and capital expenditure needs. There are multiple ways to calculate FCF and we use the following definition^[See [investopedia.com](https://www.investopedia.com/terms/f/freecashflow.asp) for alternative definitions.]

$$\text{FCF} = \text{EBIT} + \text{Depreciation & Amortization} - \text{Taxes} + \Delta \text{Working Capital} - \text{CAPEX}$$
Let’s break down the formula for FCF step by step:

- EBIT (Earnings Before Interest and Taxes): represents the company’s core operating profit, excluding the effects of financing and tax expenses.
-	Depreciation & Amortization: non-cash expenses that allocate the cost of tangible and intangible assets over their useful lives.
-	Taxes: the amount a company pays to the government, calculated on its taxable income.
-	$\Delta$ Working Capital: the change in current assets minus current liabilities, reflecting the cash needed to support daily operations.
-	CAPEX (Capital Expenditures): funds used by a company to acquire or upgrade physical assets like property, buildings, or equipment.

We can calculate FCF using these items as follows: 

```{r}
dcf_data <- income_statements |> 
  mutate(
    ebit = net_income + income_tax_expense - interest_expense - interest_income
  ) |> 
  select(
    year = calendar_year, 
    ebit, revenue, depreciation_and_amortization, taxes = income_tax_expense
  ) |> 
  left_join(
    cash_flow_statements |> 
      select(year = calendar_year, 
             delta_working_capital = change_in_working_capital,
             capex = capital_expenditure), join_by(year)
  ) |> 
  mutate(
    fcf = ebit + depreciation_and_amortization - taxes + delta_working_capital - capex
  ) |> 
  arrange(year) 
```

## Forecast Free-Cash-Flow

Now that we’ve covered the components of FCF, let’s discuss how to forecast FCF over the projection period. Forecasting FCF typically involves a balance between data-driven analysis and informed judgment. While historical data provides a foundation, financial analysts often need to make educated assumptions about the future. The first step is to express the components of FCF as ratios relative to revenue. This ratio-based approach makes it easier to link the components of FCF to a single driving variable: revenue.

```{r}
#| label: fig-500
#| fig-cap: "Ratios are based on financial statements as provided through the FMP API." 
#| fig-alt: "Title: Key financial ratios of Microsoft between 2020 and 2024. The figure shows a line chart with years on the horizontal axis and financial ratios on the vertical axis."
dcf_data <- dcf_data |> 
  mutate(
    revenue_growth = revenue / lag(revenue) - 1,
    operating_margin = ebit / revenue,
    da_margin = depreciation_and_amortization / revenue,
    taxes_to_revenue = taxes / revenue,
    delta_working_capital_to_revenue =  delta_working_capital / revenue,
    capex_to_revenue = capex / revenue
  )

fig_financial_ratios <- dcf_data |> 
  pivot_longer(cols = c(operating_margin:capex_to_revenue)) |>
  ggplot(aes(x = year, y = value, color = name)) +
  geom_line() +
  scale_x_continuous(breaks = pretty_breaks()) +
  scale_y_continuous(labels = percent) +
  labs(
    x = NULL, y = NULL, color = NULL,
    title = "Key financial ratios of Microsoft between 2020 and 2024"
  )
fig_financial_ratios
```

Next, analysts use their understanding of the company’s operations and industry dynamics to make subjective guesses about how these ratios might change in the future.

We define examplary ratio dynamics in @fig-501. 

```{r}
#| label: fig-501
#| fig-cap: "Realized ratios are based on financial statements as provided through the FMP API, while forecasts are manually defined." 
#| fig-alt: "Title: Key financial ratios and ad-hoc forecasts of Microsoft between 2020 and 2029. The figure shows a line chart with years on the horizontal axis and financial ratios and their forecasts on the vertical axis."
dcf_data_forecast_ratios <- tribble(
  ~year, ~operating_margin, ~da_margin, ~taxes_to_revenue, ~delta_working_capital_to_revenue, ~capex_to_revenue,
  2025, 0.41, 0.09, 0.08, 0.001, -0.2,
  2026, 0.42, 0.09, 0.07, 0.001, -0.22,
  2027, 0.43, 0.09, 0.06, 0.001, -0.2,
  2028, 0.44, 0.09, 0.06, 0.001, -0.18,
  2029, 0.45, 0.09, 0.06, 0.001, -0.16
) |> 
  mutate(type = "Forecast")

dcf_data <- dcf_data |> 
  mutate(type = "Realized") |> 
  bind_rows(dcf_data_forecast_ratios)

fig_financial_ratios_forecast <- dcf_data |> 
  pivot_longer(cols = c(operating_margin:capex_to_revenue)) |> 
  ggplot(aes(x = year, y = value, color = name, linetype = rev(type))) +
  geom_line() +
    scale_x_continuous(breaks = pretty_breaks()) +
  scale_y_continuous(labels = percent) +
  labs(
    x = NULL, y = NULL, color = NULL, linetype = NULL,
    title = "Key financial ratios and ad-hoc forecasts of Microsoft between 2020 and 2029"
  )
fig_financial_ratios_forecast
```

Finally, revenue growth projections are typically based on macroeconomic factors, such as GDP growth or industry trends, as well as company-specific factors like market share and product pipelines. A great starting point for revenue growth projections is the [IMF World Economic Outlook (WEO)](https://www.imf.org/en/Publications/WEO/weo-database/2024/October/weo-report?c=111,&s=NGDP_RPCH,&sy=2020&ey=2029&ssm=0&scsm=1&scc=0&ssd=1&ssc=0&sic=1&sort=country&ds=.&br=1) data for the US. This resource provides in-depth analyses of the global economy, including trends and forecasts for key metrics like GDP growth. However, keep in mind that macroeconomic data and hence GDP forecasts always have some inherent lag. 

A simple method is to model revenue growth as a linear function of GDP growth. The idea is straightforward: if GDP grows by, e.g., 3%, you might project company revenue to grow by a similar rate, adjusted for factors like market share and industry dynamics.

The following code chunk implements this approach:

```{r}
gdp_growth <- tibble(
  year = 2020:2029,
  gdp_growth = c(-0.02163, 0.06055,	0.02512, 0.02887, 0.02765, 0.02153, 0.02028, 0.02120, 0.02122, 0.02122)
)

dcf_data <- dcf_data |> 
  left_join(gdp_growth, join_by(year)) 

revenue_growth_model <- dcf_data |> 
  lm(revenue_growth ~ gdp_growth, data = _) |> 
  coefficients()
 
dcf_data <- dcf_data |> 
  mutate(
    revenue_growth_modeled = revenue_growth_model[1] + revenue_growth_model[2] * gdp_growth,
    revenue_growth = if_else(type == "Forecast", revenue_growth_modeled, revenue_growth)  
  ) 
```



```{r}
#| label: fig-502
#| fig-cap: "Realized revue growth rates are based on financial statements as provided through the FMP API, while forecasts are modeled unsing IMF WEO forecasts." 
#| fig-alt: "Title: GDP growth and Microsoft revenue growth and modeled forecasts between 2020 and 2029. The figure shows a line chart with years on the horizontal axis and gdp growth, revenue growth and their forecasts on the vertical axis."
fig_growth <- dcf_data |> 
  filter(year >= 2021) |> 
  pivot_longer(cols = c(revenue_growth, gdp_growth)) |> 
  ggplot(aes(x = year, y = value, color = name, linetype = rev(type))) +
  geom_line() +
  scale_x_continuous(breaks = pretty_breaks()) +
  scale_y_continuous(labels = percent) +
  labs(
    x = NULL, y = NULL, color = NULL, linetype = NULL,
    title = "GDP growth and Microsoft revenue growth and modeled forecasts between 2020 and 2029"
  )
fig_growth
```

An alternative approach would be to look up consensus analyst forecasts, but this data is typically proprietary.

Now that we have all required components, we can finally calculate FCF forecasts.

```{r}
dcf_data$revenue_growth[1] <- 0
dcf_data$revenue <- dcf_data$revenue[1] * cumprod(1 + dcf_data$revenue_growth)

dcf_data <- dcf_data |> 
  mutate(
    ebit = operating_margin * revenue,
    depreciation_and_amortization = da_margin * revenue,
    taxes = taxes_to_revenue * revenue,
    delta_working_capital = delta_working_capital_to_revenue * revenue,
    capex = capex_to_revenue * revenue,
    fcf = ebit + depreciation_and_amortization - taxes + delta_working_capital - capex
  )
```

@fig-503 Vvisualizes these FCF forecasts.

```{r}
#| label: fig-503
#| fig-cap: "Realized growth rates are based on financial statements as provided through the FMP API, while forecasts are manually defined." 
#| fig-alt: "Title: GDP growth and Microsoft revenue growth and modeled forecasts between 2020 and 2029. The figure shows a line chart with years on the horizontal axis and gdp growth, revenue growth and their forecasts on the vertical axis."
fig_fcf <- dcf_data |>
  ggplot(aes(x = year, y = fcf / 1e9)) +
  geom_col(aes(fill = type)) +
  scale_x_continuous(breaks = pretty_breaks()) +
  scale_y_continuous(labels = comma) + 
  labs(
    x = NULL, y = "Free Cash Flow (in B USD)", fill = NULL,
    title = "Actual and predicted free cash flow for Microsoft from 2020 to 2029"
  )
fig_fcf
```

## Continuation Value

Now, let’s discuss how to compute the continuation value, also known as the terminal value. This value is a critical component of the DCF analysis, as it often represents a significant portion of a company’s overall valuation. One typical approach is the Perpetuity Growth Model, which assumes that free cash flows grow at a constant rate indefinitely. The model simply assumes that cash flows grow at a constant rate indefinitely:

$$TV_{T} = \frac{{FCF_{T+1}}}{{r - g}},$$
where $r$ is the discount rate, typically measured by the WACC, and $g$ is the perpetual growth rate. 

For our application, we need to make an assumption for perpetual growth rate. For instance, last 20 years GDP growth is a sensible assumption (nominal growth rate is 4% for the US).

An alternative method is the exit multiple approach, which estimates the continuation value based on a multiple of EBITDA or another financial metric at the end of the forecast period.^[See (corporatefinanceinstitute.com/)[https://corporatefinanceinstitute.com/resources/valuation/exit-multiple/)] for an intuitive explanation of the exit multiple approach.]

```{r}
compute_terminal_value <- function(last_fcf, growth_rate, discount_rate){
  last_fcf * (1 + growth_rate) / (discount_rate - growth_rate)
}

last_fcf <- tail(dcf_data$fcf, 1)
terminal_value <- compute_terminal_value(last_fcf, 0.04, 0.08)
terminal_value / 1e9
```

## Discount Rates

As a last critical step, we need to bring future cash flows to their present value using a discount factor. In company valuation settings, the WACC typically serves this purpose. The WACC represents the average rate of return required by all the company’s investors, including both equity holders and debt holders. It reflects the overall cost of financing the company’s operations and serves as the discount rate in our valuation. The definition is a follows:

$$WACC = \frac{E}{D+E} \cdot r^E + \frac{D}{D+E} \cdot r^D \cdot (1 - \tau),$$

where $E$ is the market value of the company’s equity with required return $r^E$, $D$ is the market value of the company's debt with pre-tax return $r^D$, and $\tau$ is the tax rate.

While you can often find estimates of WACC from financial databases or analysts’ reports, sometimes you may need to calculate it yourself. Let’s walk through the practical steps to estimate WACC using real-world data: 

- $E$ is typically measured as the market value of the company’s equity. One common approach is to calculate it by subtracting net debt (total debt minus cash) from the enterprise value.
- $D$ is often measured using the book value of the company’s debt. While this might not perfectly reflect market conditions, it’s a practical starting point when market data is unavailable.
- The Capital Asset Pricing Model (CAPM) is a popular method to estimate the cost of equity $r^E$. It considers the risk-free rate, the equity risk premium, and the company’s beta. For a detailed guide on how to estimate the CAPM, we refer to Chapter [Capital Asset Pricing Model](capital-asset-pricing-model.qmd).
- The return on debt $r^D$ can also be estimated in different ways. For instance, effective interest rates can be calculated as the ratio of interest expense to total debt from financial statements. This gives you a real-world measure of what the company is currently paying. Alternatively, you can look up corporate bond spreads for companies in the same rating group. For highly rated companies like Microsoft, this would reflect their low-risk profile and correspondingly low borrowing costs.

If you'd rather not estimate WACC manually, there are excellent resources available to help you find industry-specific discount rates. One of the most widely used sources is Aswath Damodaran’s [database](https://pages.stern.nyu.edu/~adamodar/New_Home_Page/datacurrent.html). He maintains an extensive database that provides a wealth of financial data, including estimated discount rates, cash flows, growth rates, multiples, and more. What makes his database particularly valuable is its level of detail and coverage of multiple industries and regions. For example, if you’re analyzing a company in the Computer Services sector, as we do here, you can look up the industry’s average WACC and use it as a benchmark for your analysis. The following code chunk downloads the WACC data and extracts the value for this industry:

```{r}
#| cache: true
library(readxl)

file <- tempfile(fileext = "xls")

url <- "https://pages.stern.nyu.edu/~adamodar/pc/datasets/wacc.xls"
download.file(url, file)
wacc_raw <- read_xls(file, sheet = 2, skip = 18)
unlink(file)

wacc <- wacc_raw |> 
  filter(`Industry Name` == "Computer Services") |> 
  pull(`Cost of Capital`)
```

## Compute DCF Value

$$
\text{Total DCF Value} = \sum_{t=1}^{\text{T}} \frac{\text{FCF}_t}{(1 + \text{WACC})^t} + \frac{\text{TV}_{T}}{(1 + \text{WACC})^{\text{T}}}
$$


```{r}
forecasted_years <- 5

compute_dcf <- function(wacc, growth_rate, years = 5) {
  free_cash_flow <- dcf_data$fcf
  last_fcf <- tail(free_cash_flow, 1)
  terminal_value <- compute_terminal_value(last_fcf, growth_rate, wacc)
  
  present_value_fcf <- free_cash_flow / (1 + wacc)^(1:years)
  present_value_tv <- terminal_value / (1 + wacc)^years
  total_dcf_value <- sum(present_value_fcf) + present_value_tv
  total_dcf_value
}

compute_dcf(wacc, 0.03) / 1e9
```

## Sensitvity Analysis

One of the key challenges in a DCF analysis is that it relies heavily on assumptions about the future, growth, and risk. This is where sensitivity analysis comes into play, helping us understand how changes in these assumptions can impact our valuation. For instance, small changes in assumptions like operating margin or CAPEX as a percentage of revenue might lead to noticeable shifts in FCF projections, or overestimating or underestimating revenue growth might have a cascading effect on cash flow projections.

We focus on the commonly biggest drivers of valuation that can have dramatic effects on the calculation: the perpetual growth rate and the WACC. The following code chunk implements different WACC and growth scenarios:

```{r}
#| label: fig-504
#| fig-cap: "DCF value combines data from FMP API, ad-hoc forecasts of financial ratios, and IMF WEO growth forecasts." 
#| fig-alt: "Title: DCF value of Microsoft for different WACC and growth scenarios. The figure shows a tile chart different values of WACC on the horizontal axis and perpetual growth rates on the vertical axis. Each tile shows a corresponding DCF value, illustrating the sensitivity of the DCF analysis to assumptions."
wacc_range <- seq(0.06, 0.08, by = 0.01)
growth_rate_range <- seq(0.02, 0.04, by = 0.01)

sensitivity <- expand_grid(
  wacc = wacc_range,
  growth_rate = growth_rate_range
) |>
  mutate(value = pmap_dbl(list(wacc, growth_rate), compute_dcf))

fig_sensitivity <- sensitivity |> 
  mutate(value = round(value / 1e9, 0)) |> 
  ggplot(aes(x = wacc, y = growth_rate, fill = value)) +
  geom_tile() +
  geom_text(aes(label = comma(value)), color = "white") +
  scale_x_continuous(labels = percent) + 
  scale_y_continuous(labels = percent) +
  scale_fill_continuous(labels = comma) + 
  labs(
    title = "DCF value of Microsoft for different WACC and growth scenarios",
    x = "WACC",
    y = "Perpetual growth rate",
    fill = "Company value"
  ) + 
  guides(fill = guide_colorbar(barwidth = 15, barheight = 0.5))
fig_sensitivity
```

@fig-504 shows that ...

## From DCF to Equity Value

DCF model provides an estimate for value of operations

$$\text{Equity Value} = \text{DCF Value} + \text{Non-Operating Assets} - \text{Value of Debt}$$

- Non-Operating Assets: not essential to operations, but generate income (e.g., marketable securities, vacant land, idle equipment)
- Value of Debt: in theory market value of total debt, in practice book debt

## Key takeaways

The DCF method provides a structured framework for making informed decisions. By breaking down the valuation process into clear, logical steps, it helps analysts and decision-makers focus on the fundamentals that drive value. DCF stands out because it values companies or projects based on their projected future cash flows, rather than just historical data or market sentiment. This forward-looking approach makes it especially useful for long-term strategic decisions. The three core elements that we discussed in this chapter are: free cash flow, continuation value, and the WACC. Finally, the quality of a DCF analysis critically depends on the assumptions we make. Key drivers like financial ratios, revenue growth, and WACC require careful validation, as even small errors can lead to significant deviations in valuation.

## Exercises

1. ...

