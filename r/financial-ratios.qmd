---
title: Financial Ratios
metadata:
  pagetitle: Financial Ratios with R
  description-meta: Learn how to use the programming language R to analyze companies using financial ratios.
cache: true
---

Financial statements and ratios are fundamental tools for understanding and evaluating companies. While the previous chapter on the [Capital Asset Pricing Model](capital-asset-pricing-model.qmd) focused on how assets are priced in equilibrium, this chapter examines how investors and analysts assess individual companies using accounting information. Financial statements serve as the primary source of standardized information about a company's operations, financial position, and performance. Their standardization and legal requirements make them particularly valuable: all companies must file financial statements, and public companies face additional scrutiny through mandatory independent audits and regular filings with the Securities and Exchange Commission (SEC).

Building on this foundation of standardized financial information, financial ratios transform raw accounting data into meaningful metrics that facilitate analysis across companies and over time. These ratios serve multiple purposes in both academic research and practical applications. They enable investors to benchmark companies against their peers, identify industry trends, and screen for investment opportunities. In academic finance, ratios play a crucial role in asset pricing models - from the book-to-market ratio in the Fama-French three-factor model discussed in Value and Bivariate Sorts to the investment and profitability ratios underlying the Q-factor model. Moreover, ratios help assess a company's financial health, capital structure decisions, and potential distress risk.

This chapter demonstrates how to access, process, and analyze financial statements using R. We show how to calculate key financial ratios, implement common screening strategies, and evaluate companies' financial health. Our analysis combines theoretical frameworks with practical implementation, providing tools for both academic research and investment practice.

We use the following packages throughout this chapter:

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(tidyfinance)
library(scales)
library(ggrepel)
library(fmpapi)
```

## Balance Sheet Statements

The balance sheet is one of the three primary financial statements, alongside the income statement and cash flow statement. It captures a company's financial position at a specific moment in time, much like a financial photograph. The statement is built on the fundamental accounting equation:

$$\text{Assets} = \text{Liabilities} + \text{Shareholders’ Equity}$$

This equation reflects a core principle of accounting: a company's resources (assets) must equal its sources of funding, whether from creditors (liabilities) or investors (shareholders' equity). Assets represent resources that the company controls and expects to generate future economic benefits, such as cash, inventory, or equipment. Liabilities encompass all obligations to external parties, from short-term payables to long-term debt. Shareholders' equity, sometimes called net worth or book value, represents the residual claim on assets after accounting for all liabilities.

@fig-400 provides a stylized representation of a balance sheet's structure. The visualization highlights how assets on the left side must equal the combined claims of creditors and shareholders on the right side. This balance illustrates the dual nature of corporate finance: every asset must be financed either through debt (liabilities) or equity.

![A stylized representation of a balance sheet statement.](../assets/img/balance-sheet.svg){#fig-400 alt="A stylized representation of a balance sheet statement."}

The asset side of the balance sheet typically comprises three main categories, each serving different roles in the company's operations:

1. Current Assets: These are assets expected to be converted into cash or used within one operating cycle (typically one year). They include: cash and cash equivalents, short-term investments, accounts receivable (money owed by customers), inventory (raw materials, work in progress, and finished goods).
1. Non-Current Assets: These long-term assets support the company's operations beyond one year: Property, Plant, and Equipment (PP&E), long-term investments, other long-term assets.
1. Intangible Assets: These non-physical assets often represent significant value in modern companies: patents and intellectual property, trademarks and brands, goodwill from acquisitions, Software and development costs.

@fig-401 illustrates this hierarchical breakdown of assets, showing how companies classify their resources based on liquidity and nature.
 
![A stylized representation of a breakdown of assets on a balance sheet.](../assets/img/assets.svg){#fig-401 alt="A stylized representation of a breakdown of assets on a balance sheet."}

The liability side similarly follows a temporal classification, dividing obligations based on when they come due:

1. Current Liabilities: Obligations due within one year such as accounts payable, short-term debt, current portion of long-term debt, accrued expenses.
1. Non-Current Liabilities: Long-term obligations such as long-term debt, bonds payable, deferred tax liabilities, pension obligations.

@fig-402 shows this breakdown, highlighting how companies structure their debt obligations.

![A stylized representation of a breakdown of liabilities on a balance sheet.](../assets/img/liabilities.svg){#fig-402 alt="A stylized representation of a breakdown of liabilities on a balance sheet."}

Lastly, the equity section represents ownership claims and typically consists of:

- Retained Earnings: Accumulated profits reinvested in the business. 
- Common Stock: Par value and additional paid-in capital from share issuance
- Preferred Stock: Hybrid securities with characteristics of both debt and equity

@fig-403 depicts this equity structure, showing how companies track different forms of ownership claims.

![A stylized representation of a breakdown of equity on a balance sheet.](../assets/img/equity.svg){#fig-403 alt="A stylized representation of a breakdown of equity on a balance sheet."}

To illustrate these concepts in practice, @fig-404 presents Microsoft's balance sheet from 2023. This real-world example demonstrates how one of the world's largest technology companies structures its financial position, reflecting both traditional elements like PP&E and modern aspects like significant intangible assets.

![A screenshot of the balance sheet statement of Microsoft in 2023.](../assets/img/balance-sheet-msft.png){#fig-404 alt="A screenshot of the balance sheet statement of Microsoft in 2023."}

Microsoft's balance sheet exemplifies several key trends in modern corporate finance: the growing importance of intangible assets in technology companies, the strategic use of cash and investments, and the complex interplay between different forms of financing. In subsequent sections, we'll explore how to analyze such statements using financial ratios, particularly focusing on measures of liquidity, solvency, and efficiency.

While the SEC provides a web interface to search filings, programmatic access to financial statements greatly facilitates systematic analysis. The Financial Modeling Prep (FMP) API offers such programmatic access, which we can leverage through the R package fmpapi.

The FMP API's free tier provides access to:

- 250 API calls per day
- 5 years of historical fundamental data
- Real-time and historical stock prices
- Key financial ratios and metrics

Let's examine Microsoft's balance sheet statements using the `fmp_get()` function. This function requires three main arguments: The type of financial data to retrieve (`resource`), the stock ticker symbol (`symbol`), and additional parameters like periodicity and number of periods (`params`).

```{r}
#| cache: true 
fmp_get(
  resource = "balance-sheet-statement", 
  symbol = "MSFT", 
  params = list(period = "annual", limit = 5)
)
```

The function returns a data frame containing detailed balance sheet information, with each row representing a different reporting period. This structured format makes it easy to analyze trends over time and calculate financial ratios. We can see how the data aligns with the balance sheet components we discussed earlier, from current assets like cash and receivables to long-term assets and various forms of liabilities and equity.

## Income Statements

While the balance sheet provides a snapshot of a company's financial position at a point in time, the income statement (also called profit and loss statement) measures financial performance over a period, typically a quarter or year. It follows a hierarchical structure that progressively captures different levels of profitability:

- Revenue (Sales): the total income generated from goods or services sold.
- Cost of Goods Sold (COGS): direct costs associated with producing the goods or services (raw materials, labor, etc.).
- Gross Profit: revenue minus COGS, showing the basic profitability from core operations.
- Operating Expenses: costs related to regular business operations (Salaries, Rent, Marketing).
- Operating Income (EBIT): earnings before interest and taxes (measures profitability from core operations before financing and tax costs).
- Net Income: The “bottom line”—total profit after all expenses, taxes, and interest are subtracted from revenue.

@fig-405 illustrates this progression from total revenue to net income, showing how various costs and expenses are subtracted to arrive at different profitability measures.

![A stylized representation of an income statement.](../assets/img/income-statements.svg){#fig-405 alt="A stylized representation of an income statement."}

Consider Microsoft's 2023 income statement in @fig-406, which exemplifies how a leading technology company reports its financial performance:

![A screenshot of the income statement of Microsoft in 2023.](../assets/img/income-statements-msft.png){#fig-406 alt="A screenshot of the income statement of Microsoft in 2023."}

We can also access this data programmatically using the FMP API:

```{r}
#| cache: true 
fmp_get(
  resource = "income-statement", 
  symbol = "MSFT", 
  params = list(period = "annual", limit = 5)
)
```

The structured format of this data enables systematic analysis of profitability trends and operational efficiency. In later sections, we'll use these figures to calculate important profitability ratios and examine how they compare across companies and industries. The income statement's focus on performance complements the balance sheet's position snapshot, providing a more complete picture of a company's financial health.

## Cash Flow Statements

The cash flow statement complements the balance sheet and income statement by tracking the actual movement of cash through the business. While the income statement shows profitability and the balance sheet shows financial position, the cash flow statement reveals a company's ability to generate and manage cash - a crucial aspect of financial health. The statement is divided into three main categories:

- Operating Activities: cash generated from a company’s core business activities (Net Income adjusted for non-cash items like depreciation, and changes in working capital).
- Financing Activities: cash flows related to borrowing, repaying debt, issuing equity, or paying dividends.
- Investing Activities: cash spent on or received from long-term investments, such as purchasing or selling property, equipment, or securities.

@fig-407 illustrates how these three categories combine to show the overall change in a company's cash position.

![A stylized representation of a cash flow statement.](../assets/img/cash-flow-statements.svg){#fig-407 alt="A stylized representation of a cash flow statement."}

The statement reconciles accrual-based accounting (used in the income statement) with actual cash movements. This reconciliation is crucial because profitable companies can still face cash shortages, and unprofitable companies might maintain positive cash flow. Microsoft's 2023 cash flow statement in @fig-408 demonstrates how a large technology company manages its cash flows:

![A screenshot of the cash flow statement of Microsoft in 2023.](../assets/img/cash-flow-statements-msft.png){#fig-408 alt="A screenshot of the cash flow statement of Microsoft in 2023."}

Of course, we can access this data systematically through the FMP API:

```{r}
#| cache: true 
fmp_get(
  resource = "cash-flow-statement", 
  symbol = "MSFT", 
  params = list(period = "annual", limit = 5)
)
```

In subsequent sections, we'll use this data to calculate important cash flow ratios that help assess a company's liquidity, capital allocation efficiency, and overall financial sustainability. The combination of all three financial statements - balance sheet, income statement, and cash flow statement - provides a comprehensive view of a company's financial health and performance.

## Download Financial Statements

We now turn to downloading and processing statements for multiple companies systematically. The next code chunk demonstrates how to retrieve financial data for all constituents of the Dow Jones Industrial Average, similar to our approach in the CAPM chapter.

```{r}
#| cache: true 
constituents <- download_data_constituents("Dow Jones Industrial Average") |> 
  pull(symbol)

params <- list(period = "annual", limit = 5)

balance_sheet_statements <- constituents |> 
  map_df(
    \(x) fmp_get(resource = "balance-sheet-statement", symbol = x, params = params)
  )

income_statements <- constituents |> 
  map_df(
    \(x) fmp_get(resource = "income-statement", symbol = x, params = params)
  )

cash_flow_statements <- constituents |> 
  map_df(
    \(x) fmp_get(resource = "cash-flow-statement", symbol = x, params = params)
  )
```

The resulting datasets provide a foundation for cross-sectional analysis of financial ratios and trends across major U.S. companies. In the following sections, we'll use these datasets to calculate various financial ratios and analyze patterns in corporate financial performance.

## Liquidity Ratios

Liquidity ratios assess a company's ability to meet its short-term obligations and are typically calculated using balance sheet items. These ratios are particularly important for creditors and investors concerned about a company's short-term financial health and ability to cover immediate obligations.

The Current Ratio is the most basic measure of liquidity, comparing all current assets to current liabilities:

$$\text{Current Ratio} = \frac{\text{Current Assets}}{\text{Total Assets}}$$

A ratio above 1 indicates that the company has enough current assets to cover its current liabilities. 

However, not all current assets are equally liquid, leading to the Quick Ratio:

$$\text{Quick Ratio} = \frac{\text{Current Assets - Inventory}}{\text{Current Liabilities}}$$
The Quick Ratio provides a more stringent measure of liquidity by excluding inventory, which is typically the least liquid current asset. A ratio above 1 suggests strong short-term solvency without relying on inventory sales.

The most conservative liquidity measure is the Cash Ratio:

$$\text{Cash Ratio} = \frac{\text{Cash and Cash Equivalents}}{\text{Current Liabilities}}$$

This ratio focuses solely on the most liquid assets - cash and cash equivalents. While a ratio of 1 indicates robust liquidity, most companies maintain lower cash ratios to avoid holding excessive non-productive assets.
Let's calculate these ratios for Dow Jones constituents, focusing on three major technology companies:

```{r}
selected_symbols <- c("MSFT", "AAPL", "AMZN")

balance_sheets_statements <- balance_sheet_statements |> 
  mutate(
    current_ratio = total_current_assets / total_assets,
    quick_ratio = (total_current_assets - inventory) / total_current_liabilities,
    cash_ratio = cash_and_cash_equivalents / total_current_liabilities,
    label = if_else(symbol %in% selected_symbols, symbol, NA),
  )
```

@fig-409 compares these liquidity ratios across Microsoft, Apple, and Amazon for 2023:

```{r}
#| label: fig-409
#| fig-cap: "Liquidity ratios are based on financial statements as provided through the FMP API." 
#| fig-alt: "Title: Liquidity ratios for selected stocks for 2023. The figure shows a bar chart liquidity ratios on the vertical and corresponding values on the horizontal axis."
fig_liquidity_ratios <- balance_sheets_statements |> 
  filter(calendar_year == 2023 & !is.na(label)) |> 
  select(symbol, contains("ratio")) |> 
  pivot_longer(-symbol) |> 
  mutate(name = str_to_title(str_replace_all(name, "_", " "))) |> 
  ggplot(aes(x = value, y = name, fill = symbol)) +
  geom_col(position = "dodge") +
  scale_x_continuous(labels = percent) + 
  labs(
    x = NULL, y = NULL, fill = NULL,
    title = "Liquidity ratios for selected stocks from the Dow index for 2023"
  )
fig_liquidity_ratios
```

The liquidity ratios for Microsoft, Apple, and Amazon in 2023 reveal distinct patterns in how these technology giants manage their short-term financial positions. Microsoft demonstrates the most conservative approach with the highest quick ratio of around 160%, significantly above Amazon's 100% and Apple's 90%, indicating strong ability to cover short-term obligations without relying on inventory. However, all three companies maintain relatively modest current ratios between 30-50%, which might appear concerning but is typical for technology companies with strong cash flows and limited inventory needs. Their cash ratios also show interesting variation, with Amazon leading at 45%, followed by Microsoft at 40%, and Apple maintaining a more conservative cash position at 20%. These patterns reflect the technology sector's characteristics of minimal inventory requirements and strategic cash management, while also highlighting company-specific differences in financial management approaches, with Microsoft generally maintaining the most conservative liquidity position overall.

## Leverage Ratios

Leverage ratios assess a company's capital structure and its ability to meet financial obligations. These metrics are crucial for understanding financial risk and long-term solvency. We examine three key leverage measures:

The debt-to-equity ratio indicates how much a company is financing its operations through debt versus shareholders' equity:

$$\text{Debt-to-Equity} = \frac{\text{Total Debt}}{\text{Total Equity}}$$

The debt-to-asset ratio shows the percentage of assets financed through debt:

$$\text{Debt-to-Asset} = \frac{\text{Total Debt}}{\text{Total Assets}}$$

Interest coverage measures a company's ability to meet interest payments:

$$\text{Interest Coverage} = \frac{\text{EBIT}}{\text{Interest Expense}}$$

Let's calculate these ratios for our sample of companies:

```{r}
balance_sheets_statements <- balance_sheets_statements |> 
  mutate(
    debt_to_equity = total_debt / total_equity,
    debt_to_asset = total_debt / total_assets
  )

income_statements <- income_statements |> 
  mutate(
    interest_coverage = operating_income / interest_expense,
    label = if_else(symbol %in% selected_symbols, symbol, NA),
  )
```

@fig-410 tracks the evolution of debt-to-asset ratios for Microsoft, Apple, and Amazon over time:

```{r}
#| label: fig-410
#| fig-cap: "Debt-to-asset ratios are based on financial statements as provided through the FMP API." 
#| fig-alt: "Title: Debt-to-asset ratios of selected stocks between 2020 and 2024. The figure shows a line chart with years on the horizontal axis and debt-to-asset ratios on the vertical axis."
fig_debt_to_asset <- balance_sheets_statements |> 
  filter(symbol %in% selected_symbols) |> 
  ggplot(aes(x = calendar_year, y = debt_to_asset,
             color = symbol)) +
  geom_line(linewidth = 1) +
  scale_y_continuous(labels = percent) +
  labs(x = NULL, y = NULL, color = NULL,
       title = "Debt-to-asset ratios of selected stocks between 2020 and 2024") 
fig_debt_to_asset
```

@fig-411 shows debt-to-asset ratio in the cross-section

```{r}
#| label: fig-411
#| fig-cap: "Debt-to-asset ratios are based on financial statements as provided through the FMP API." 
#| fig-alt: "Title: Debt-to-asset ratios of Dow index constituents in 2023. The figure shows a bar chart with debt-to-asset ratios on the horizontal and corresponding symbols on the vertical axis."
selected_colors <- c("#F21A00", "#EBCC2A", "#3B9AB2", "lightgrey")

fig_debt_to_asset_cross_section <-  balance_sheets_statements |> 
  filter(calendar_year == 2023) |> 
  ggplot(aes(x = debt_to_asset,
             y = fct_reorder(symbol, debt_to_asset),
             fill = label)) +
  geom_col() +
  scale_x_continuous(labels = percent) +
  scale_fill_manual(values = selected_colors) +
  labs(x = NULL, y = NULL, color = NULL,
       title = "Debt-to-asset ratios of Dow index constituents in 2023") + 
  theme(legend.position = "none")
fig_debt_to_asset_cross_section
```

@fig-412 shows debt-to-asset vs interest coverage
 
```{r}
#| label: fig-412
#| fig-cap: "Debt-to-asset ratios and interest coverages are based on financial statements as provided through the FMP API." 
#| fig-alt: "Title: Debt-to-asset ratios and interest coverages for Dow index constituents. The figure shows a scatter plot with debt-to-asset on the horizontal and interest coverage on the vertical axis."
fig_debt_to_asset_interest_coverage <- income_statements |> 
  filter(calendar_year == 2023) |> 
  select(symbol, interest_coverage, calendar_year) |> 
  left_join(
    balance_sheets_statements,
    join_by(symbol, calendar_year)
  ) |> 
  ggplot(aes(x = debt_to_asset, y = interest_coverage, color = label)) +
  geom_point(size = 2) +
  geom_label_repel(aes(label = label), seed = 42, box.padding = 0.75) +
  scale_x_continuous(labels = percent) +
  scale_y_continuous(labels = percent) +
  scale_color_manual(values = selected_colors) +
  labs(
    x = "Debt-to-Asset", y = "Interest Coverage",
    title = "Debt-to-asset ratios and interest coverages for Dow index constituents"
  ) +
  theme(legend.position = "none")
fig_debt_to_asset_interest_coverage
```

## Efficiency Ratios

Asset Turnover measures how efficiently a company uses its assets to generate revenue. A higher ratio indicates more efficient use of assets. 

$$\text{Asset Turnover} = \frac{\text{Revenue}}{\text{Total Assets}}$$

Inventory turnover indicates how many times a company’s inventory is sold and replaced over a period. The higher the ratio, the more efficient is the inventory management. 

$$\text{Inventory Turnover} = \frac{\text{COGS}}{\text{Inventory}}$$

Receivables turnover measures how effectively a company collects receivables. A higher ratio indicates a more efficient credit and collection processes. 

$$\text{Receivables Turnover} = \frac{\text{Revenue}}{\text{Accounts Receivable}}$$

```{r}
combined_statements <- balance_sheets_statements |> 
  select(symbol, calendar_year, label, current_ratio, quick_ratio, cash_ratio,
         debt_to_equity, debt_to_asset, total_assets, total_equity) |> 
  left_join(
    income_statements |> 
      select(symbol, calendar_year, interest_coverage, revenue, cost_of_revenue,
             selling_general_and_administrative_expenses, interest_expense,
             gross_profit, net_income),
    join_by(symbol, calendar_year)
  ) |> 
  left_join(
    cash_flow_statements |> 
      select(symbol, calendar_year, inventory, accounts_receivables),
     join_by(symbol, calendar_year)
  )

combined_statements <- combined_statements |> 
  mutate(
    asset_turnover = revenue / total_assets,
    inventory_turnover = cost_of_revenue / inventory,
    receivables_turnover = revenue / accounts_receivables
  )
```

## Profitability Ratios

Gross margin shows the percentage of revenue that exceeds the cost of goods sold (COGS). A higher gross margin implies that the company retains a higher percentage of revenue as gross profit. 

$$\text{Gross Margin} = \frac{\text{Gross Profit}}{\text{Revenue}}$$

Profit margin is the percentage of revenue that translates into net income. A higher profit margin suggests a more profitable company. 

$$\text{Profit Margin} = \frac{\text{Net Income}}{\text{Revenue}}$$

After-tax ROE measures the return on shareholders' equity after accounting for taxes. A higher ROE indicates that the company is effectively generating profit from shareholders' investments. 

$$\text{After-Tax ROE} = \frac{\text{Net Income}}{\text{Total Equity}}$$

```{r}
combined_statements <- combined_statements |> 
  mutate(
    gross_margin = gross_profit / revenue,
    profit_margin = net_income / revenue,
    after_tax_roe = net_income / total_equity
  )
```

Gross margin over time @fig-413 shows

```{r}
#| label: fig-413
#| fig-cap: "Gross margins are based on financial statements as provided through the FMP API." 
#| fig-alt: "Title: Gross margins for selected stocks between 2019 and 2023. The figure shows a line chart with years on the horizontal axis and gross margins on the vertical axis."
fig_gross_margin <- combined_statements |> 
  filter(symbol %in% selected_symbols) |> 
  ggplot(aes(x = calendar_year, y = gross_margin, color = symbol)) +
  geom_line() +
  scale_y_continuous(labels = percent) + 
  labs(x = NULL, y = NULL, color = NULL,
       title = "Gross margins for selected stocks between 2019 and 2023")
fig_gross_margin
```

Profit margin vs gross margin @fig-414 shows

```{r}
#| label: fig-414
#| fig-cap: "Gross and profit margins are based on financial statements as provided through the FMP API." 
#| fig-alt: "Title: Gross and profit margins for Dow index constituents for 2023. The figure shows a scatter plot with gross margins on the horizontal and profit margins on the vertical axis."
fig_gross_margin_profit_margin <- combined_statements |> 
  filter(calendar_year == 2023) |> 
  ggplot(aes(x = gross_margin, y = profit_margin, color = label)) +
  geom_point(size = 2) +
  geom_label_repel(aes(label = label), seed = 42, box.padding = 0.75) +
  scale_x_continuous(labels = percent) +
  scale_y_continuous(labels = percent) + 
  scale_color_manual(values = selected_colors) + 
  labs(
    x = "Gross margin", y = "Profit margin",
    title = "Gross and profit margins for Dow index constituents for 2023"
  )  +
  theme(legend.position = "none")
fig_gross_margin_profit_margin
```

## Combining Financial Ratios

Ranking companies in different categories

@fig-415 shows

```{r}
#| label: fig-415
#| fig-cap: "Ranks are based on financial statements as provided through the FMP API." 
#| fig-alt: "Title: Rank in financial ratio categories for selected stocks from the Dow index. The figure shows a scatter plot with ranks for selected stocks on the horizontal and categories of financial ratios on the vertical axis."
financial_ratios <- combined_statements |> 
  filter(calendar_year == 2023) |> 
  select(symbol, 
         contains(c("ratio", "margin", "roe", "_to_", "turnover", "interest_coverage"))) |> 
  pivot_longer(cols = -symbol) |> 
  mutate(
    type = case_when(
      name %in% c("current_ratio", "quick_ratio", "cash_ratio") ~ "Liquidity Ratios",
      name %in% c("debt_to_equity", "debt_to_asset", "interest_coverage") ~ "Leverage Ratios",
      name %in% c("asset_turnover", "inventory_turnover", "receivables_turnover") ~ "Efficiency Ratios",
      name %in% c("gross_margin", "profit_margin", "after_tax_roe") ~ "Profitability Ratios"
    )
  ) 

fig_ranks <- financial_ratios |> 
  group_by(type, name) |> 
  arrange(desc(value)) |> 
  mutate(rank = row_number()) |> 
  group_by(symbol, type) |> 
  summarize(rank = mean(rank), 
            .groups = "drop") |> 
  filter(symbol %in% selected_symbols) |> 
  ggplot(aes(x = rank, y = type, color = symbol)) +
  geom_point(shape = 17, size = 4) +
  scale_color_manual(values = selected_colors) + 
  labs(x = "Average rank", y = NULL, color = NULL,
       title = "Average rank among Dow index constituents for selected stocks") +
  coord_cartesian(xlim = c(1, 30))
fig_ranks
```

## Financial Ratios in Asset Pricing

The Fama-French five-factor model aims to explain stock returns by incorporating specific financial metrics ratios. We provide more details in [Replicating Fama-French Factors](replicating-fama-and-french-factors.qmd), but here is an intuitive overview:

-  Size: Calculated as the logarithm of a company’s market capitalization, which is the total market value of its outstanding shares. This factor captures the tendency for smaller firms to outperform larger ones over time.
- Book-to-Market Ratio: Determined by dividing the company’s book equity by its market capitalization. A higher ratio indicates a 'value' stock, while a lower ratio suggests a 'growth'’' stock. This metric helps differentiate between undervalued and overvalued companies.
- Profitability: Measured as the ratio of operating profit to book equity, where operating profit is calculated as revenue minus cost of goods sold (COGS), selling, general, and administrative expenses (SG&A), and interest expense. This factor assesses a company’s efficiency in generating profits from its equity base.
- Investment: Calculated as the percentage change in total assets from the previous period. This factor reflects the company’s growth strategy, indicating whether it is investing aggressively or conservatively.

We can calculate these factors using the FMP API as follows:

```{r}
market_cap <- constituents |> 
  map_df(
    \(x) fmp_get(
      resource = "historical-market-capitalization", 
      x, 
      list(from = "2023-12-29", to = "2023-12-29")
    )
  ) 

combined_statements_ff <- combined_statements |> 
  filter(calendar_year == 2023) |> 
  left_join(market_cap, join_by(symbol)) |> 
  left_join(
    balance_sheets_statements |> 
      filter(calendar_year == 2022) |> 
      select(symbol, total_assets_lag = total_assets), 
    join_by(symbol)
  ) |> 
  mutate(
    size = log(market_cap),
    book_to_market = market_cap / total_equity,
    operating_profitability = (revenue - cost_of_revenue - selling_general_and_administrative_expenses - interest_expense) / total_equity,
    investment = total_assets / total_assets_lag
  )
```

@fig-416 shows the ranks of our selected stocks for the Fama-French factors. 

```{r}
#| label: fig-416
#| fig-cap: "Ranks are based on financial statements and historical market capitalization as provided through the FMP API." 
#| fig-alt: "Title: Rank in Fama-French variables for selected stocks from the Dow index. The figure shows a scatter plot with ranks for selected stocks on the horizontal and Fama-French variables on the vertical axis."
fig_rank_ff <- combined_statements_ff |> 
  select(symbol, Size = size, 
         `Book-to-Market` = book_to_market, 
         `Profitability` = operating_profitability,
         Investment = investment) |> 
  pivot_longer(-symbol) |> 
  group_by(name) |> 
  arrange(desc(value)) |> 
  mutate(rank = row_number()) |> 
  ungroup() |> 
  filter(symbol %in% selected_symbols) |> 
  ggplot(aes(x = rank, y = name, color = symbol)) +
  geom_point(shape = 17, size = 4) +
  scale_color_manual(values = selected_colors) + 
  labs(
    x = "Rank", y = NULL, color = NULL,
    title = "Rank in Fama-French variables for selected stocks from the Dow index"
  ) +
  coord_cartesian(xlim = c(1, 30))
fig_rank_ff
```

## Key Takeaways

- Financial statements provide standardized, legally required insights into a company’s financial position
- Ratios allow benchmarking & trend analysis across liquidity, leverage, efficiency & profitability dimensions
- `fmpapi` enables easy access to financial data for ratio calculations & peer comparisons

## Exercises

1. ...

