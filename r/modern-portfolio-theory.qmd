---
title: Modern Portfolio Theory
metadata:
  pagetitle: Modern Portfolio Theory with R
  description-meta: Learn how to use the programming language R for implementing the Markowitz model for portfolio optimization.
---

In the previous chapter, we showed how to download stock market data and analyze them with graphs and summary statistics. Now, we move to a typical question in Finance: how should wealth be allocated across assets with varying returns, risks, and correlations to optimize a portfolio’s performance?\index{Portfolio choice} Modern Portfolio Theory (MPT), introduced by [@Markowitz1952], revolutionized the way we think about such investments by formalizing the trade-off between risk and return. Markowitz’s framework laid the foundation for much of modern finance, earning him the Sveriges Riksbank Prize in Economic Sciences in 1990.

Markowitz demonstrates that portfolio risk depends not only on individual asset volatilities but also on the correlations between asset returns. This insight highlights the power of diversification: combining assets with low or negative correlations reduces overall portfolio risk. This principle is often illustrated with the analogy of a fruit basket: If all you have are apples & they spoil, you lose everything. With a variety of fruits, some fruits may spoil, but others will stay fresh.

At the heart of MPT is mean-variance analysis, which evaluates portfolios based on two dimensions: expected return and risk. By balancing these two factors, investors can construct portfolios that either maximize return for a given level of risk or minimize risk for a desired level of return.

We use the following packages throughout this chapter: 

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(tidyfinance)
library(scales)
library(ggrepel)
```

<!-- TODO: add citation and explanation for ggrepel -->

## Estimate Expected Returns

Expected returns, denoted as $\mu_i$, represent the anticipated profit from holding an asset $i$. They are typically estimated using historical data by computing the average of past returns:

$$\hat{\mu}_i = \frac{1}{T} \sum_{t=1}^{T} r_{it},$$

where $r_{it}$ is the return of asset $i$ in period $t$, and $T$ is the total number of periods. While past performance does not guarantee future results, the typical assumption is that it is at least indicative of future performance.

Leveraging the approach of [Working with Stock Returns](working-with-stock-returns.qmd), we download the constituents of the Dow Jones Industrial Average as an example portfolio, as well as their daily adjusted close prices:

```{r}
#| output: false
symbols <- download_data(
  type = "constituents",
  index = "Dow Jones Industrial Average"
)

prices_daily <- download_data(
    type = "stock_prices", symbol = symbols$symbol,
    start_date = "2019-08-01", end_date = "2024-07-31"
) |> 
  select(symbol, date,  price = adjusted_close)

prices_daily
```

Then, we proceed to calculate daily returns for each asset. 

```{r}
returns_daily <- prices_daily |>
  group_by(symbol) |> 
  mutate(ret = price / lag(price) - 1) |>
  ungroup() |> 
  select(symbol, date, ret) |> 
  drop_na(ret) |> 
  arrange(symbol, date)

returns_daily 
```

We can use the tidy return data to quickly calcualte the estimated expected return of each asset in the Dow Jones Industrial Average.

```{r}
assets <- returns_daily |> 
  group_by(symbol) |> 
  summarize(mu = mean(ret))
```

Figure @fig-201 shows the corresponding average daily returns of the constituents of our example portfolio. 

```{r}
#| label: fig-201
#| fig-cap: "Average daily returns based on prices adjusted for dividend payments and stock splits." 
#| fig-alt: "Title: Average daily stock returns of Dow index constituents. The figure shows 30 bars with average daily returns."
fig_mu <- assets |> 
  ggplot(aes(x = mu, y = fct_reorder(symbol, mu), 
             fill = mu > 0)) +
  geom_col() +
  scale_x_continuous(labels = percent) + 
  labs(x = NULL, y = NULL, fill = NULL,
       title = "Average daily returns of Dow index constituents")  +
  theme(legend.position = "none")
fig_mu
```

## Estimate the Variance-Covariance Matrix

Individual asset risk in MPT is typically quantified using variance ($\sigma^2$) or volatilities ($\sigma$). The latter can be estimated as:

$$\hat{\sigma}_i = \sqrt{\frac{1}{T-1} \sum_{t=1}^{T} (r_{it} - \hat{\mu}_i)^2}$$


Next, we transform the returns from a tidy tibble into a $(T \times N)$ matrix with one column for each of the $N$ symbols and one row for each of the $T$ trading days to compute the sample average return vector $$\hat\mu = \frac{1}{T}\sum\limits_{t=1}^T r_t$$ where $r_t$ is the $N$ vector of returns on date $t$ and the sample covariance matrix $$\hat\Sigma = \frac{1}{T-1}\sum\limits_{t=1}^T (r_t - \hat\mu)(r_t - \hat\mu)'.$$ We achieve this by using `pivot_wider()` with the new column names from the column `symbol` and setting the values to `ret`. We compute the vector of sample average returns and the sample variance-covariance matrix, which we consider as proxies for the parameters of the distribution of future stock returns. Thus, for simplicity, we refer to $\Sigma$ and $\mu$ instead of explicitly highlighting that the sample moments are estimates. \index{Covariance} In later chapters, we discuss the issues that arise once we take estimation uncertainty into account.

```{r}
volatilities <- returns_daily |> 
  group_by(symbol) |> 
  summarize(sigma = sd(ret))

assets <- assets |> 
  left_join(volatilities, join_by(symbol))
```

Figure @fig-202 shows the corresponding invidiual stock volatitilies. 

```{r}
#| label: fig-202
#| fig-cap: "Daily volatilities based on prices adjusted for dividend payments and stock splits." 
#| fig-alt: "Title: Daily volatilities of DOW index constituents. The figure shows 30 bars with daily volatilities."
fig_sigma <- assets |> 
  ggplot(aes(x = sigma, y = fct_reorder(symbol, sigma))) +
  geom_col() +
  scale_x_continuous(labels = percent) + 
  labs(x = NULL, y = NULL,
       title = "Daily volatilities of Dow index constituents")
fig_sigma
```

*Covariance* measures interaction between assets

$$\hat{\sigma}_{ij} = \frac{1}{T-1} \sum_{t=1}^{T} (R_{it} - \hat{\mu}_i)(R_{jt} - \hat{\mu}_j)$$

**Interpretation**:

- **Positive**: assets move in the same direction, potentially increasing portfolio risk
- **Negative**: assets move in opposite directions, which can reduce risk through diversification

Estimating the *variance-covariance matrix*

```{r}
returns_wide <- returns_daily |> 
  pivot_wider(names_from = symbol, values_from = ret) 

vcov <- returns_wide |> 
  select(-date) |> 
  cov()
```

Figure @fig-203 provides an illustration of the variance-covariance matrix. 

```{r}
#| label: fig-203
#| fig-cap: "Average daily returns based on prices adjusted for dividend payments and stock splits." 
#| fig-alt: "Title: Variance-covariance matrix of DOW index constituents. The figure shows 900 tiles with variances and covariances between each constituent-pair."
fig_vcov <- vcov |> 
  as_tibble(rownames = "symbol_a") |> 
  pivot_longer(-symbol_a, names_to = "symbol_b") |> 
  ggplot(aes(x = symbol_a, y = fct_rev(symbol_b), fill = value)) +
  geom_tile() +
  labs(
    x = NULL, y = NULL, fill = "(Co-)Variance",
    title = "Variance-covariance matrix of Dow index constituents"
  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
fig_vcov
```

## The Minimum-Variance Framework

$\text{Expected Portfolio Return} = \sum_{i=1}^n \omega_i \hat{\mu}_i$

-	$\omega_i$: weight of asset $i$ in the portfolio
- $\hat{\mu}_i$: estimated expected return of asset $i$

Example:

- Asset A: 60% weight, expected return 8%
- Asset B: 40% weight, expected return 12%
- $(0.6 \times 8\%) + (0.4 \times 12\%) = 9.6\%$

**Assumption**: portfolio weights are constant over time

Portfolio variance is calculated as

$$\sum_{i=1}^{n} \sum_{j=1}^{n} \omega_i \omega_j \hat{\sigma}_{ij}$$

- $\omega_i$,  $\omega_j$: the weights of assets  $i$,  $j$  in the portfolio
- $\hat{\sigma}_{ij}$: covariance between returns of assets  $i$  and  $j$
-	$n$: number of assets in portfolio

**Minimize portfolio variance**

$$\min_{\omega_1, ... \omega_n} \sum_{i=1}^{n} \sum_{j=1}^{n} \omega_i \omega_j \hat{\sigma}_{ij}$$

while staying **fully invested**

$$\sum_{i=1}^{n} \omega_i = 1$$

Minimum variance in *matrix notation*

**Minimize portfolio variance**

$$\min_{\omega} \omega' \hat{\Sigma} \omega$$

while staying **fully invested**

$$ \omega'\iota = 1$$

Solution for minimum-variance portfolio

$$\omega_\text{mvp} = \frac{\Sigma^{-1}\iota}{\iota'\Sigma^{-1}\iota}$$

- $\iota$: vector of 1's
- $\Sigma^{-1}$: inverse of variance-covariance matrix $\Sigma$

Then, we compute the minimum variance portfolio weights $\omega_\text{mvp}$ as well as the expected portfolio return $\omega_\text{mvp}'\mu$ and volatility $\sqrt{\omega_\text{mvp}'\Sigma\omega_\text{mvp}}$ of this portfolio. \index{Minimum variance portfolio} Recall that the minimum variance portfolio is the vector of portfolio weights that are the solution to $$\omega_\text{mvp} = \arg\min \omega'\Sigma \omega \text{ s.t. } \sum\limits_{i=1}^N\omega_i = 1.$$ The constraint that weights sum up to one simply implies that all funds are distributed across the available asset universe, i.e., there is no possibility to retain cash. It is easy to show analytically that $\omega_\text{mvp} = \frac{\Sigma^{-1}\iota}{\iota'\Sigma^{-1}\iota}$, where $\iota$ is a vector of ones and $\Sigma^{-1}$ is the inverse of $\Sigma$.

```{r}
iota <- rep(1, dim(vcov)[1])
vcov_inv <- solve(vcov)
omega_mvp <- as.vector(vcov_inv %*% iota) / 
  as.numeric(t(iota) %*% vcov_inv %*% iota)
```

Figure @fig-204 shows the resulting portfolio weights. 

```{r}
#| label: fig-204
#| fig-cap: "Weights are based on returns adjusted for dividend payments and stock splits." 
#| fig-alt: "Title: Minimum-variance portfolio weights. The figure shows a bar chart with portfolio weights for each DOW index constituent."
assets <- bind_cols(assets, omega_mvp = omega_mvp)

fig_omega_mvp <- assets |>
  ggplot(aes(x = omega_mvp, y = fct_reorder(symbol, omega_mvp), 
             fill = omega_mvp > 0)) +
  geom_col() +
  scale_x_continuous(labels = percent) + 
  labs(x = NULL, y = NULL, 
       title = "Minimum-variance portfolio weights") +
  theme(legend.position = "none")
fig_omega_mvp
```

Minimum-variance portfolio return

```{r}
mu <- assets$mu

summary_mvp <- tibble(
  mu = sum(omega_mvp * mu),
  sigma = as.numeric(sqrt(t(omega_mvp) %*% vcov %*% omega_mvp)),
  type = "Minimum-Variance Portfolio"
)

summary_mvp
```

## Efficient Portfolios

**Minimize portfolio variance**

$$\min_{\omega} \omega' \hat{\Sigma} \omega$$

While earning **minimum expected return** $\bar{\mu}$

- $$ \omega'\iota = 1$$
- $\omega'\hat{\mu} = \bar{\mu}$

Dow Jones vs Nasdaq 100

```{r}
download_data(
  type = "stock_prices", 
  symbol = c("^DJI", "^NDX"), 
  start_date = "2019-08-01", end_date = "2024-07-31"
) |> 
  group_by(symbol) |> 
  arrange(date) |> 
  mutate(adjusted_close = adjusted_close / first(adjusted_close)) |> 
  ggplot(aes(x = date, y = adjusted_close, color = symbol)) +
  geom_line() +
  scale_y_continuous(labels = percent) + 
  labs(x = NULL, y = NULL, color = NULL,
       title = "Performance of Dow (^DJI) vs Nasdaq 100 (^NDX)",
       subtitle = "Both indexes start at 100%") 
```

Choose a minimum expected return: Achieve at least average Nasdaq 100 return:



```{r}
mu_bar <- download_data(
  "stock_prices", symbol = "^NDX", 
  start_date = "2019-08-01", end_date = "2024-07-31"
) |> 
  mutate(
    ret = adjusted_close / lag(adjusted_close) - 1
  ) |> 
  summarize(mean(ret, na.rm = TRUE)) |> 
  pull() 
```

**Note:** $\bar\mu$ needs to be higher than $\hat\mu_{mvp}$

Solution for efficient portfolio:

$$\omega_{efp} = \frac{\lambda^*}{2}\left(\Sigma^{-1}\mu -\frac{D}{C}\Sigma^{-1}\iota \right)$$ 

where $\lambda^* = 2\frac{\bar\mu - D/C}{E-D^2/C}$, $C = \iota'\Sigma^{-1}\iota$, $D=\iota'\Sigma^{-1}\mu$ & $E=\mu'\Sigma^{-1}\mu$

See details on [tidy-finance.org](https://www.tidy-finance.org/r/introduction-to-tidy-finance.html#the-efficient-frontier)

Calculate efficient portfolio

The command `solve(A, b)` returns the solution of a system of equations $Ax = b$. If `b` is not provided, as in the example above, it defaults to the identity matrix such that `solve(sigma)` delivers $\Sigma^{-1}$ (if a unique solution exists).\
Note that the *monthly* volatility of the minimum variance portfolio is of the same order of magnitude as the *daily* standard deviation of the individual components. Thus, the diversification benefits in terms of risk reduction are tremendous!\index{Diversification}

Next, we set out to find the weights for a portfolio that achieves, as an example, three times the expected return of the minimum variance portfolio. However, mean-variance investors are not interested in any portfolio that achieves the required return but rather in the efficient portfolio, i.e., the portfolio with the lowest standard deviation. If you wonder where the solution $\omega_\text{eff}$ comes from: \index{Efficient portfolio} The efficient portfolio is chosen by an investor who aims to achieve minimum variance *given a minimum acceptable expected return* $\bar{\mu}$. Hence, their objective function is to choose $\omega_\text{eff}$ as the solution to $$\omega_\text{eff}(\bar{\mu}) = \arg\min \omega'\Sigma \omega \text{ s.t. } \omega'\iota = 1 \text{ and } \omega'\mu \geq \bar{\mu}.$$

The code below implements the analytic solution to this optimization problem for a benchmark return $\bar\mu$, which we set to 3 times the expected return of the minimum variance portfolio. We encourage you to verify that it is correct.

```{r}
C <- as.numeric(t(iota) %*% vcov_inv %*% iota)
D <- as.numeric(t(iota) %*% vcov_inv %*% mu)
E <- as.numeric(t(mu) %*% vcov_inv %*% mu)
lambda_tilde <- as.numeric(2 * (mu_bar - D / C) / (E - D^2 / C))
omega_efp <- as.vector(omega_mvp + lambda_tilde / 2 * (vcov_inv %*% mu - D * omega_mvp))

summary_efp <- tibble(
  mu = sum(omega_efp * mu),
  sigma = as.numeric(sqrt(t(omega_efp) %*% vcov %*% omega_efp)),
  type = "Efficient Portfolio"
)
```

Figure @fig-205 sows the average return and volatility of the the minimum-variance and efficient portfolio relative to the index constituents. 

```{r}
#| label: fig-205
#| fig-cap: "The big dots indicate the location of the minimum variance and the efficient portfolio that delivers the expected return of the Nasdaq 100, respectively. The small dots indicate the location of the individual constituents." 
#| fig-alt: "Title: Minimum-variance portfolio weights. The figure shows a bar chart with portfolio weights for each Dow index constituent."
#| warning: false
summaries <- bind_rows(
  assets, summary_mvp, summary_efp
) 

fig_summaries <- summaries |> 
  ggplot(aes(x = sigma, y = mu)) +
  geom_point(
    data = summaries |> filter(is.na(type))
  ) +
  geom_point(
    data = summaries |> filter(!is.na(type)), color = "#F21A00", size = 3
  ) +
  geom_label_repel(aes(label = type)) +
  scale_x_continuous(labels = percent) +
  scale_y_continuous(labels = percent) + 
  labs(
    x = "Volatility", y = "Average return",
    title = "Efficient & minimum-variance portfolios for Dow index constituents"
    ) 
fig_summaries
```

## The Efficient Frontier

\index{Efficient frontier} An essential tool to evaluate portfolios in the mean-variance context is the *efficient frontier*, the set of portfolios which satisfies the condition that no other portfolio exists with a higher expected return but with the same volatility (the square root of the variance, i.e., the risk), see, e.g., @Merton1972.\index{Return volatility} We compute and visualize the efficient frontier for several stocks. First, we extract each asset's *monthly* returns. In order to keep things simple, we work with a balanced panel and exclude Dow constituents for which we do not observe a price on every single trading day since the year 2000.

\index{Separation theorem} The [mutual fund separation theorem](https://en.wikipedia.org/wiki/Mutual_fund_separation_theorem) states that as soon as we have two efficient portfolios (such as the minimum variance portfolio $\omega_\text{mvp}$ and the efficient portfolio for a higher required level of expected returns $\omega_\text{eff}(\bar{\mu})$, we can characterize the entire efficient frontier by combining these two portfolios. That is, any linear combination of the two portfolio weights will again represent an efficient portfolio. \index{Efficient frontier} The code below implements the construction of the *efficient frontier*, which characterizes the highest expected return achievable at each level of risk.

$$\omega_{eff} = a \cdot \omega_{efp} + (1-a) \cdot\omega_{mvp}$$

```{r}
efficient_frontier <- tibble(
  a = seq(from = -1, to = 4, by = 0.01),
) |> 
  mutate(
    omega = map(a, ~ .x * omega_efp + (1 - .x) * omega_mvp),
    mu = map_dbl(omega, ~ t(.x) %*% mu),
    sigma = map_dbl(omega, ~ sqrt(t(.x) %*% vcov %*% .x)),
  ) 
```

The code above proceeds in two steps: First, we compute a vector of combination weights $a$ and then we evaluate the resulting linear combination with $a\in\mathbb{R}$:\
$$\omega^* = a\omega_\text{eff}(\bar\mu) + (1-a)\omega_\text{mvp} = \omega_\text{mvp} + \frac{\lambda^*}{2}\left(\Sigma^{-1}\mu -\frac{D}{C}\Sigma^{-1}\iota \right)$$ with $\lambda^* = 2\frac{a\bar\mu + (1-a)\tilde\mu - D/C}{E-D^2/C}$ where $C = \iota'\Sigma^{-1}\iota$, $D=\iota'\Sigma^{-1}\mu$, and $E=\mu'\Sigma^{-1}\mu$. Finally, it is simple to visualize the efficient frontier alongside the two efficient portfolios within one powerful figure using `ggplot` (see @fig-206). We also add the individual stocks in the same call. We compute annualized returns based on the simple assumption that monthly returns are independent and identically distributed. Thus, the average annualized return is just 12 times the expected monthly return.\index{Graph!Efficient frontier}

```{r}
#| label: fig-206
#| fig-cap: "The big dots indicate the location of the minimum variance and the efficient portfolio that delivers 3 times the expected return of the minimum variance portfolio, respectively. The small dots indicate the location of the individual constituents."
#| fig-alt: "Title: Efficient frontier for Dow index constituents. The figure shows Dow index constituents in a mean-variance diagram. A hyperbola indicates the efficient frontier of portfolios that dominate the individual holdings in the sense that they deliver higher expected returns for the same level of volatility."
#| warning: false
summaries <- bind_rows(
    summaries, efficient_frontier
  )

fig_efficient_frontier <- summaries |> 
  ggplot(aes(x = sigma, y = mu)) +
  geom_point(
    data = summaries |> filter(is.na(type))
  ) +
  geom_point(
    data = summaries |> filter(!is.na(type)), color = "#F21A00", size = 3
  ) +
  geom_label_repel(aes(label = type)) +
  scale_x_continuous(labels = percent) +
  scale_y_continuous(labels = percent) + 
  labs(x = "Volatility", y = "Average return",
       title = "Efficient frontier for Dow index constituents") + 
  theme(legend.position = "none")
fig_efficient_frontier
```

## Extending the Markowitz Model

Replicate minimum-variance via `PortfolioAnalytics` package. 

```{r}
#| message: false
#| warning: false
library(PortfolioAnalytics)
library(CVXR)
```

```{r}
returns_matrix <- column_to_rownames(
  returns_wide, var = "date"
)

problem_mvp <- portfolio.spec(colnames(returns_matrix)) |>
  add.objective(type = "risk", name = "var") |> 
  add.constraint("full_investment")

solution_mvp <- optimize.portfolio(
  returns_matrix, problem_mvp, optimize_method = "CVXR"
)

all.equal(omega_mvp, as.vector(solution_mvp$weights))
```

Replicate efficient portfolio via *PortfolioAnalytics*

```{r}
problem_efp <- problem_mvp |> 
  add.constraint("return", return_target = mu_bar)

solution_efp <- optimize.portfolio(
  returns_matrix, problem_efp, optimize_method = "CVXR"
)

all.equal(omega_efp, as.vector(solution_efp$weights)) 
```

Easy to extend Markowitz model

- Short sale constraints: `add.constraint("long_only")`
- Position limit: `add.constraint("position_limit", max_pos = 10)`
- Expected shortfall: `add.objective(type = "risk", name = "ES")`

.. and many more, see [official *PortfolioAnalytics* vignette](https://cran.r-project.org/web/packages/PortfolioAnalytics/vignettes/portfolio_vignette.pdf) 

- Mean-variance framework is a cornerstone of finance
- Download financial data using `tidyfinance` package
- Easy to compute analytic solutions 'manually'
- Implement extensions using `PortfolioAnalytics`
- More advanced: [constrained optimization & backtesting](https://www.tidy-finance.org/r/constrained-optimization-and-backtesting.html)

## Key Takeaways

...

## Exercises

1. In the portfolio choice analysis, we restricted our sample to all assets trading every day since 2000. How is such a decision a problem when you want to infer future expected portfolio performance from the results?
1. The efficient frontier characterizes the portfolios with the highest expected return for different levels of risk. Identify the portfolio with the highest expected return per standard deviation. Which famous performance measure is close to the ratio of average returns to the standard deviation of returns?